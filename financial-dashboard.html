<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIP-BOY 財務管理システム</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #22c55e;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            position: relative;
        }

        /* CRT overlay */
        .crt-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            opacity: 0.1;
            background: repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.15) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0,0,0,0.15) 3px
            );
        }

        /* Main terminal */
        .terminal {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #064e3b 0%, #000 100%);
            border: 8px solid #374151;
            border-radius: 8px;
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.3), inset 0 0 40px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 30px;
        }

        /* Scanline effect */
        .scanline {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.05;
            background: linear-gradient(transparent 50%, rgba(34, 197, 94, 0.3) 50%);
            background-size: 100% 4px;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(100%); }
        }

        /* Header */
        .header {
            border: 2px solid #22c55e;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            z-index: 5;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #22c55e;
        }

        .subtitle {
            text-align: center;
            font-size: 14px;
            border-top: 1px solid #16a34a;
            padding-top: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid #166534;
            color: #16a34a;
            font-family: inherit;
            font-size: 11px;
            padding: 5px 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .tab-btn.active {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        /* Main content area */
        .main-area {
            flex: 1;
            display: flex;
            gap: 15px;
            position: relative;
            z-index: 5;
            overflow: hidden;
        }

        .panel {
            background: rgba(0,0,0,0.6);
            border: 2px solid #166534;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 100%; /* PL/BS/CFなどでスクロール可能にするため */
        }

        .panel-header {
            background: rgba(22, 101, 52, 0.3);
            padding: 10px 15px;
            border-bottom: 1px solid #166534;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 14px;
            font-weight: bold;
        }

        .panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Left panel - 40% */
        .left-panel {
            width: 40%;
        }

        /* Right panel - 60% */
        .right-panel {
            width: 60%;
        }

        /* Content sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Data table */
        .data-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(22, 101, 52, 0.3);
            font-size: 13px;
            align-items: center;
        }

        .data-row:hover {
            background: rgba(34, 197, 94, 0.05);
        }

        .data-label {
            color: #16a34a;
        }

        .data-value {
            color: #22c55e;
            font-weight: bold;
            text-align: right;
        }

        .section-header {
            background: rgba(34, 197, 94, 0.15);
            padding: 10px;
            font-weight: bold;
            margin-top: 15px;
            margin-bottom: 5px;
            border: 1px solid #22c55e;
        }

        .section-total {
            background: rgba(34, 197, 94, 0.2);
            font-weight: bold;
            border-top: 2px solid #22c55e;
            border-bottom: 2px solid #22c55e;
        }

        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }

        .form-label {
            display: block;
            font-size: 11px;
            margin-bottom: 5px;
            color: #16a34a;
        }

        .form-input {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #166534;
            color: #22c55e;
            font-family: inherit;
            font-size: 13px;
        }

        .form-input:focus {
            outline: none;
            border-color: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
        }

        select.form-input {
            cursor: pointer;
        }

        textarea.form-input {
            min-height: 60px;
            resize: vertical;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            color: #22c55e;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: rgba(34, 197, 94, 0.2);
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 10px;
            width: auto;
            margin: 0;
        }

        /* List items */
        .list-item {
            padding: 10px;
            border-bottom: 1px solid rgba(22, 101, 52, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        .list-item:hover {
            background: rgba(34, 197, 94, 0.05);
        }

        .list-item-info {
            flex: 1;
        }

        .list-item-date {
            font-size: 10px;
            color: #16a34a;
        }

        .list-item-category {
            margin: 3px 0;
        }

        .list-item-memo {
            font-size: 10px;
            color: #16a34a;
        }

        .list-item-amount {
            font-size: 16px;
            font-weight: bold;
            margin: 0 10px;
        }

        .badge {
            display: inline-block;
            padding: 2px 6px;
            font-size: 9px;
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid #22c55e;
            margin-left: 5px;
        }

        /* Summary box */
        .summary-box {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid #22c55e;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .summary-label {
            font-size: 11px;
            color: #16a34a;
        }

        .summary-value {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 0 10px #22c55e;
            margin: 5px 0;
        }

        /* Chart bars */
        .chart-container {
            margin: 20px 0;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            height: 150px;
            margin: 15px 0;
        }

        .bar-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        .bar-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .bar {
            width: 20px;
            background: #22c55e;
            box-shadow: 0 0 8px #22c55e;
            transition: all 0.3s;
        }

        .bar-label {
            margin-top: 8px;
            font-size: 10px;
            color: #16a34a;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: #166534;
            border: 1px solid #22c55e;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #22c55e;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #000;
            border: 2px solid #22c55e;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.5);
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            color: #22c55e;
            padding-bottom: 10px;
            border-bottom: 1px solid #166534;
        }

        .modal-body {
            padding: 15px;
        }

        /* Filter buttons */
        .filter-group {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px;
            background: transparent;
            border: 1px solid #166534;
            color: #16a34a;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .filter-btn.active {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="crt-overlay"></div>
        <div class="terminal">
            <div class="scanline"></div>

            <!-- Header -->
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div class="title">PIP-BOY 3000 Mk.IV　　<span style="font-size: 20px;">&gt;&gt; FINANCIAL &lt;&lt;</span></div>
                    <div style="text-align: right; font-size: 14px;">
                        <div style="margin-bottom: 3px;" id="dashboardDate"></div>
                        <div style="font-size: 20px; font-weight: bold;" id="dashboardTime"></div>
                    </div>
                </div>
                <div class="subtitle">
                    <button class="tab-btn active" onclick="app.switchTab('overview')">概要</button>
                    <button class="tab-btn" onclick="app.switchTab('pl')">損益計算書</button>
                    <button class="tab-btn" onclick="app.switchTab('bs')">貸借対照表</button>
                    <button class="tab-btn" onclick="app.switchTab('cf')">キャッシュフロー</button>
                    <button class="tab-btn" onclick="app.switchTab('input')">収支入力</button>
                    <button class="tab-btn" onclick="app.switchTab('credit')">クレジット管理</button>
                    <button class="tab-btn" onclick="app.switchTab('finance')">財務活動</button>
                    <button class="tab-btn" onclick="app.switchTab('recurring')">定期支払い</button>
                </div>
            </div>

            <!-- Main Area -->
            <div class="main-area">
                <!-- Overview Tab -->
                <div class="content-section active" id="overviewSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">財務概要ダッシュボード</span>
                        </div>
                        <div class="panel-body">
                            <!-- Summary boxes -->
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div class="summary-box">
                                    <div class="summary-label">今月の純利益</div>
                                    <div class="summary-value" id="monthlyProfit">¥0</div>
                                </div>
                                <div class="summary-box">
                                    <div class="summary-label">現金残高（現在）</div>
                                    <div class="summary-value" id="cashBalanceCurrent">¥0</div>
                                </div>
                                <div class="summary-box">
                                    <div class="summary-label">現金残高（月末）</div>
                                    <div class="summary-value" id="cashBalanceEndOfMonth">¥0</div>
                                </div>
                                <div class="summary-box">
                                    <div class="summary-label">クレジット未払金</div>
                                    <div class="summary-value" id="creditBalance">¥0</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 20px;">
                                <div class="summary-box">
                                    <div class="summary-label">今月支払予定</div>
                                    <div class="summary-value" id="currentPaymentSchedule">¥0</div>
                                    <div style="font-size: 10px; color: #16a34a; margin-top: 5px;" id="paymentScheduleDate">-</div>
                                </div>
                            </div>

                            <!-- Recent transactions -->
                            <div class="section-header">最近の収支</div>
                            <div id="recentList"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Tab -->
                <div class="content-section" id="inputSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">収支入力</span>
                        </div>
                        <div class="panel-body">
                            <!-- Input Form -->
                            <div style="max-width: 600px; margin: 0 auto 30px;">
                                <div class="form-group">
                                    <label class="form-label">日付:</label>
                                    <input type="date" class="form-input" id="inputDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">種別:</label>
                                    <div class="filter-group">
                                        <button class="filter-btn" id="typeIncome" onclick="app.setInputType('income')">収入</button>
                                        <button class="filter-btn active" id="typeExpense" onclick="app.setInputType('expense')">支出</button>
                                    </div>
                                </div>
                                <div class="form-group" id="categoryGroup">
                                    <label class="form-label">カテゴリ:</label>
                                    <select class="form-input" id="inputCategory">
                                        <optgroup label="収入" id="incomeGroup" style="display:none;">
                                            <option value="給与">給与</option>
                                            <option value="ボーナス">ボーナス</option>
                                            <option value="借入金">借入金</option>
                                            <option value="その他収入">その他収入</option>
                                        </optgroup>
                                        <optgroup label="支出" id="expenseGroup">
                                            <option value="食費">食費</option>
                                            <option value="住居費">住居費</option>
                                            <option value="水道光熱費">水道光熱費</option>
                                            <option value="通信費">通信費</option>
                                            <option value="交通費">交通費</option>
                                            <option value="娯楽費">娯楽費</option>
                                            <option value="医療費">医療費</option>
                                            <option value="その他支出">その他支出</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">金額:</label>
                                    <input type="number" class="form-input" id="inputAmount" placeholder="0" style="font-size: 18px; font-weight: bold;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">メモ:</label>
                                    <input type="text" class="form-input" id="inputMemo" list="memoHistory" placeholder="メモ（任意）">
                                    <datalist id="memoHistory"></datalist>
                                </div>
                                <div class="form-group" id="creditGroup" style="display: none;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="inputCredit" style="margin-right: 8px;">
                                        <span style="font-size: 11px;">クレジットカード支払い（未払金計上）</span>
                                    </label>
                                </div>
                                <button class="btn" onclick="app.saveEntry()">&gt;&gt;&gt; 追加 &lt;&lt;&lt;</button>
                            </div>

                            <!-- Entry List -->
                            <div class="section-header">入力履歴 [<span id="entryCount">0</span>]</div>
                            <div id="entryList"></div>
                        </div>
                    </div>
                </div>

                <!-- Credit Card Tab -->
                <div class="content-section" id="creditSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">クレジットカード未払金管理</span>
                            <button class="btn btn-small" onclick="app.showCreditSettings()" style="margin-left: auto;">⚙ 設定</button>
                        </div>
                        <div class="panel-body">
                            <!-- Summary boxes -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div class="summary-box" style="padding: 15px;">
                                    <div class="summary-label" style="font-size: 11px;">今月引落分</div>
                                    <div class="summary-value" style="font-size: 24px; color: #ef4444;" id="currentMonthCredit">¥0</div>
                                    <div style="font-size: 10px; color: #16a34a; margin-top: 5px;">引落日: <span id="creditPaymentDay">-</span></div>
                                </div>
                                <div class="summary-box" style="padding: 15px;">
                                    <div class="summary-label" style="font-size: 11px;">来月引落分</div>
                                    <div class="summary-value" style="font-size: 24px; color: #f59e0b;" id="nextMonthCredit">¥0</div>
                                    <div style="font-size: 10px; color: #16a34a; margin-top: 5px;">対象期間: <span id="creditPeriod">-</span></div>
                                </div>
                            </div>

                            <div class="summary-box">
                                <div class="summary-label">未払金合計</div>
                                <div class="summary-value" id="totalCredit">¥0</div>
                            </div>
                            <div id="creditList"></div>
                        </div>
                    </div>
                </div>

                <!-- Credit Settings Modal -->
                <div class="modal" id="creditSettingsModal">
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">クレジットカード設定</div>
                        <div class="modal-body" style="padding: 20px;">
                            <div class="form-group">
                                <label class="form-label">締め日:</label>
                                <select class="form-input" id="creditClosingDay">
                                    ${Array.from({length: 31}, (_, i) => i + 1).map(d => 
                                        `<option value="${d}">${d}日</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">引落日:</label>
                                <select class="form-input" id="creditPaymentDayInput">
                                    ${Array.from({length: 31}, (_, i) => i + 1).map(d => 
                                        `<option value="${d}">${d}日</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div style="font-size: 11px; color: #16a34a; margin-top: 10px; line-height: 1.6;">
                                例: 締め日「月末(31日)」、引落日「翌月27日」<br>
                                → 1/1-1/31の利用分が2/27に引き落とし
                            </div>
                            <div style="display: flex; gap: 10px; margin-top: 20px;">
                                <button class="btn" onclick="app.saveCreditSettings()" style="flex: 1; background: rgba(34, 197, 94, 0.2);">保存</button>
                                <button class="btn" onclick="app.closeCreditSettings()" style="flex: 1;">キャンセル</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Finance Tab -->
                <div class="content-section" id="financeSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">財務活動（借入・返済）</span>
                        </div>
                        <div class="panel-body">
                            <!-- Finance Form -->
                            <div style="max-width: 600px; margin: 0 auto 30px;">
                                <div class="form-group">
                                    <label class="form-label">日付:</label>
                                    <input type="date" class="form-input" id="financeDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">種別:</label>
                                    <select class="form-input" id="financeType">
                                        <option value="借入">借入金</option>
                                        <option value="返済">借入金返済</option>
                                        <option value="クレジット返済">クレジット引落</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">金額:</label>
                                    <input type="number" class="form-input" id="financeAmount" placeholder="0" style="font-size: 18px; font-weight: bold;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">メモ:</label>
                                    <textarea class="form-input" id="financeMemo" placeholder="メモ（任意）"></textarea>
                                </div>
                                <button class="btn" onclick="app.saveFinance()">&gt;&gt;&gt; 追加 &lt;&lt;&lt;</button>
                            </div>

                            <!-- Finance List -->
                            <div class="section-header">財務活動履歴</div>
                            <div id="financeList"></div>
                        </div>
                    </div>
                </div>

                <!-- PL/BS/CF Tabs will render here -->
                <div class="content-section" id="plSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">損益計算書 (Profit & Loss)</span>
                        </div>
                        <div class="panel-body" id="plContent"></div>
                    </div>
                </div>

                <div class="content-section" id="bsSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">貸借対照表 (Balance Sheet)</span>
                        </div>
                        <div class="panel-body" id="bsContent"></div>
                    </div>
                </div>

                <div class="content-section" id="cfSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">キャッシュフロー計算書 (Cash Flow)</span>
                        </div>
                        <div class="panel-body" id="cfContent"></div>
                    </div>
                </div>

                <div class="content-section" id="recurringSection" style="width: 100%;">
                    <div class="panel" style="width: 100%;">
                        <div class="panel-header">
                            <span class="panel-title">定期支払い管理</span>
                        </div>
                        <div class="panel-body">
                            <!-- Add New Recurring Payment Form -->
                            <div style="max-width: 600px; margin: 0 auto 30px;">
                                <div class="form-group">
                                    <label class="form-label">名称:</label>
                                    <input type="text" class="form-input" id="recurringName" list="recurringNameHistory" placeholder="例: Netflix月額">
                                    <datalist id="recurringNameHistory"></datalist>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">カテゴリ:</label>
                                    <select class="form-input" id="recurringCategory">
                                        <option value="食費">食費</option>
                                        <option value="住居費">住居費</option>
                                        <option value="水道光熱費">水道光熱費</option>
                                        <option value="通信費">通信費</option>
                                        <option value="交通費">交通費</option>
                                        <option value="娯楽費">娯楽費</option>
                                        <option value="医療費">医療費</option>
                                        <option value="その他支出">その他支出</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">金額:</label>
                                    <input type="number" class="form-input" id="recurringAmount" placeholder="0" style="font-size: 18px; font-weight: bold;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">支払日（毎月）:</label>
                                    <input type="number" class="form-input" id="recurringDay" placeholder="1-31" min="1" max="31">
                                </div>
                                <div class="form-group">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="recurringCredit" style="margin-right: 8px;">
                                        <span style="font-size: 11px;">クレジットカード支払い</span>
                                    </label>
                                </div>
                                <button class="btn" onclick="app.saveRecurring()">&gt;&gt;&gt; 登録 &lt;&lt;&lt;</button>
                            </div>

                            <!-- Recurring Payments List -->
                            <div class="section-header">登録済み定期支払い [<span id="recurringCount">0</span>]</div>
                            <div id="recurringList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const app = {
            currentTab: 'overview',
            currentInputType: 'expense',
            entries: [],
            financeEntries: [],
            recurringPayments: [],
            creditSettings: {
                closingDay: 31,    // 締め日（デフォルト: 月末）
                paymentDay: 27     // 引落日（デフォルト: 27日）
            },
            lastCreditUsed: false, // 前回のクレジット使用状態を保持

            init() {
                this.loadData();
                this.generateRecurringPayments(); // 定期支払いを自動生成
                this.render();
                document.getElementById('inputDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('financeDate').value = new Date().toISOString().split('T')[0];
                this.setInputType('expense'); // 初期表示で支出を選択し、クレジットオプションを表示
                
                // 日時表示を開始
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
            },

            updateDateTime() {
                const now = new Date();
                const date = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
                const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                document.getElementById('dashboardDate').textContent = date;
                document.getElementById('dashboardTime').textContent = time;
            },

            loadData() {
                this.entries = JSON.parse(localStorage.getItem('financialEntries') || '[]');
                this.financeEntries = JSON.parse(localStorage.getItem('financeEntries') || '[]');
                this.recurringPayments = JSON.parse(localStorage.getItem('recurringPayments') || '[]');
                this.creditSettings = JSON.parse(localStorage.getItem('creditSettings') || '{"closingDay":31,"paymentDay":27}');
                this.lastCreditUsed = JSON.parse(localStorage.getItem('lastCreditUsed') || 'false');
                
                // 既存データに creditPaid フィールドを追加（互換性対応）
                this.entries = this.entries.map(entry => {
                    if (entry.isCredit && entry.creditPaid === undefined) {
                        entry.creditPaid = false; // デフォルトは未払い
                    }
                    return entry;
                });
            },

            saveData() {
                localStorage.setItem('financialEntries', JSON.stringify(this.entries));
                localStorage.setItem('financeEntries', JSON.stringify(this.financeEntries));
                localStorage.setItem('recurringPayments', JSON.stringify(this.recurringPayments));
                localStorage.setItem('creditSettings', JSON.stringify(this.creditSettings));
                localStorage.setItem('lastCreditUsed', JSON.stringify(this.lastCreditUsed));
            },

            switchTab(tab) {
                this.currentTab = tab;
                document.querySelectorAll('.content-section').forEach(el => el.style.display = 'none');
                document.getElementById(tab + 'Section').style.display = 'block';
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            },

            setInputType(type) {
                this.currentInputType = type;
                document.querySelectorAll('#inputSection .filter-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById('type' + (type === 'income' ? 'Income' : 'Expense')).classList.add('active');
                
                // Show/hide optgroups
                const incomeGroup = document.getElementById('incomeGroup');
                const expenseGroup = document.getElementById('expenseGroup');
                const creditGroup = document.getElementById('creditGroup');
                
                if (type === 'income') {
                    incomeGroup.style.display = 'block';
                    expenseGroup.style.display = 'none';
                    creditGroup.style.display = 'none';
                    document.getElementById('inputCategory').value = '給与';
                } else {
                    incomeGroup.style.display = 'none';
                    expenseGroup.style.display = 'block';
                    creditGroup.style.display = 'block';
                    document.getElementById('inputCategory').value = '食費';
                    // 前回の状態を復元
                    document.getElementById('inputCredit').checked = this.lastCreditUsed;
                }
                
                // メモ履歴を更新
                this.updateMemoHistory();
            },

            updateMemoHistory() {
                const memoList = document.getElementById('memoHistory');
                const memos = [...new Set(this.entries.map(e => e.memo).filter(m => m))];
                memoList.innerHTML = memos.map(m => `<option value="${m}">`).join('');
            },

            saveEntry() {
                const date = document.getElementById('inputDate').value;
                const category = document.getElementById('inputCategory').value;
                const amount = parseFloat(document.getElementById('inputAmount').value);
                const memo = document.getElementById('inputMemo').value.trim();
                const isCredit = this.currentInputType === 'expense' && document.getElementById('inputCredit').checked;

                if (!date || !amount) {
                    alert('日付と金額は必須です');
                    return;
                }

                const entry = {
                    date,
                    type: this.currentInputType, // 'income' または 'expense'
                    category,
                    amount,
                    memo,
                    isCredit,
                    creditPaid: false, // 支払済みフラグ（初期値: 未払い）
                    timestamp: Date.now()
                };
                
                console.log('保存するエントリー:', entry); // デバッグ用
                
                this.entries.push(entry);

                // クレジット状態を保存
                this.lastCreditUsed = isCredit;

                this.saveData();
                this.render();

                // Clear form (but keep credit checkbox state)
                document.getElementById('inputAmount').value = '';
                document.getElementById('inputMemo').value = '';

                alert('追加しました');
            },

            saveFinance() {
                const date = document.getElementById('financeDate').value;
                const type = document.getElementById('financeType').value;
                const amount = parseFloat(document.getElementById('financeAmount').value);
                const memo = document.getElementById('financeMemo').value.trim();

                if (!date || !amount) {
                    alert('日付と金額は必須です');
                    return;
                }

                this.financeEntries.push({
                    date,
                    type,
                    amount,
                    memo,
                    timestamp: Date.now()
                });

                // 借入の場合、収入としても記録（現金が増えるため）
                if (type === '借入') {
                    this.entries.push({
                        date,
                        type: 'income',
                        category: '借入金',
                        amount,
                        memo: memo ? `【借入】${memo}` : '【借入】',
                        isCredit: false,
                        creditPaid: false,
                        timestamp: Date.now()
                    });
                }

                this.saveData();
                this.render();

                // Clear form
                document.getElementById('financeAmount').value = '';
                document.getElementById('financeMemo').value = '';

                alert('追加しました');
            },

            render() {
                this.renderRecent();
                this.renderEntryList();
                this.renderCreditList();
                this.renderFinanceList();
                this.renderRecurringList();
                this.renderSummary();
                this.renderPL();
                this.renderBS();
                this.renderCF();
                this.updateMemoHistory();
                this.updateRecurringNameHistory();
            },

            renderRecent() {
                const list = document.getElementById('recentList');
                const recent = [...this.entries].sort((a, b) => b.timestamp - a.timestamp).slice(0, 10);
                
                list.innerHTML = '';
                recent.forEach(entry => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-item-info">
                            <div class="list-item-date">${entry.date}</div>
                            <div class="list-item-category">
                                ${entry.category}
                                ${entry.isCredit ? '<span class="badge">CREDIT</span>' : ''}
                            </div>
                            ${entry.memo ? `<div class="list-item-memo">${entry.memo}</div>` : ''}
                        </div>
                        <div class="list-item-amount" style="color: ${entry.type === 'income' ? '#22c55e' : '#ef4444'}">
                            ${entry.type === 'income' ? '+' : '-'}¥${entry.amount.toLocaleString()}
                        </div>
                    `;
                    list.appendChild(div);
                });
            },

            renderEntryList() {
                const list = document.getElementById('entryList');
                const sorted = [...this.entries].sort((a, b) => b.timestamp - a.timestamp);
                
                document.getElementById('entryCount').textContent = sorted.length;
                
                list.innerHTML = '';
                sorted.forEach((entry, i) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-item-info">
                            <div class="list-item-date">${entry.date}</div>
                            <div class="list-item-category">
                                ${entry.category}
                                ${entry.isCredit ? '<span class="badge">CREDIT</span>' : ''}
                            </div>
                            ${entry.memo ? `<div class="list-item-memo">${entry.memo}</div>` : ''}
                        </div>
                        <div class="list-item-amount" style="color: ${entry.type === 'income' ? '#22c55e' : '#ef4444'}">
                            ${entry.type === 'income' ? '+' : '-'}¥${entry.amount.toLocaleString()}
                        </div>
                        <button class="btn btn-small" onclick="app.deleteEntry(${i})">削除</button>
                    `;
                    list.appendChild(div);
                });
            },

            renderCreditList() {
                const list = document.getElementById('creditList');
                const credits = this.entries.filter(e => e.isCredit);
                const unpaidCredits = credits.filter(e => !e.creditPaid);
                const paidCredits = credits.filter(e => e.creditPaid);
                
                const unpaidTotal = unpaidCredits.reduce((sum, e) => sum + e.amount, 0);
                const paidTotal = paidCredits.reduce((sum, e) => sum + e.amount, 0);
                
                // 今月と来月の集計
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                // 締め日と引落日の計算
                const { closingDay, paymentDay } = this.creditSettings;
                
                // 今月の引落対象期間（先月の締め日翌日〜今月の締め日）
                const currentPeriodStart = new Date(currentYear, currentMonth - 1, closingDay + 1);
                const currentPeriodEnd = new Date(currentYear, currentMonth, closingDay);
                
                // 来月の引落対象期間（今月の締め日翌日〜来月の締め日）
                const nextPeriodStart = new Date(currentYear, currentMonth, closingDay + 1);
                const nextPeriodEnd = new Date(currentYear, currentMonth + 1, closingDay);
                
                const currentMonthTotal = unpaidCredits.filter(e => {
                    const date = new Date(e.date);
                    return date >= currentPeriodStart && date <= currentPeriodEnd;
                }).reduce((sum, e) => sum + e.amount, 0);
                
                const nextMonthTotal = unpaidCredits.filter(e => {
                    const date = new Date(e.date);
                    return date >= nextPeriodStart && date <= nextPeriodEnd;
                }).reduce((sum, e) => sum + e.amount, 0);
                
                document.getElementById('totalCredit').textContent = `¥${unpaidTotal.toLocaleString()}`;
                document.getElementById('creditBalance').textContent = `¥${unpaidTotal.toLocaleString()}`;
                document.getElementById('currentMonthCredit').textContent = `¥${currentMonthTotal.toLocaleString()}`;
                document.getElementById('nextMonthCredit').textContent = `¥${nextMonthTotal.toLocaleString()}`;
                
                // 引落日と期間の表示
                const paymentDate = new Date(currentYear, currentMonth + 1, paymentDay);
                document.getElementById('creditPaymentDay').textContent = 
                    `${paymentDate.getMonth() + 1}/${paymentDate.getDate()}`;
                
                const periodStartStr = `${nextPeriodStart.getMonth() + 1}/${nextPeriodStart.getDate()}`;
                const periodEndStr = `${nextPeriodEnd.getMonth() + 1}/${nextPeriodEnd.getDate()}`;
                document.getElementById('creditPeriod').textContent = `${periodStartStr}-${periodEndStr}`;
                
                list.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div class="summary-box" style="padding: 15px;">
                            <div class="summary-label" style="font-size: 11px;">未払い</div>
                            <div class="summary-value" style="font-size: 24px; color: #ef4444;">¥${unpaidTotal.toLocaleString()}</div>
                            <div style="font-size: 10px; color: #16a34a; margin-top: 5px;">${unpaidCredits.length}件</div>
                        </div>
                        <div class="summary-box" style="padding: 15px;">
                            <div class="summary-label" style="font-size: 11px;">支払済み</div>
                            <div class="summary-value" style="font-size: 24px; color: #22c55e;">¥${paidTotal.toLocaleString()}</div>
                            <div style="font-size: 10px; color: #16a34a; margin-top: 5px;">${paidCredits.length}件</div>
                        </div>
                    </div>

                    <div class="section-header">未払い一覧</div>
                `;
                
                if (unpaidCredits.length === 0) {
                    list.innerHTML += '<div style="text-align: center; padding: 20px; color: #16a34a;">未払いのクレジット支払いはありません</div>';
                } else {
                    unpaidCredits.forEach(entry => {
                        const index = this.entries.indexOf(entry);
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.innerHTML = `
                            <div class="list-item-info">
                                <div class="list-item-date">${entry.date}</div>
                                <div class="list-item-category">${entry.category}</div>
                                ${entry.memo ? `<div class="list-item-memo">${entry.memo}</div>` : ''}
                            </div>
                            <div class="list-item-amount" style="color: #ef4444;">¥${entry.amount.toLocaleString()}</div>
                            <button class="btn btn-small" onclick="app.markAsPaid(${index})" style="background: rgba(34, 197, 94, 0.2);">支払済み</button>
                        `;
                        list.appendChild(div);
                    });
                }

                // 支払済み一覧
                const paidSection = document.createElement('div');
                paidSection.innerHTML = '<div class="section-header" style="margin-top: 20px;">支払済み一覧</div>';
                list.appendChild(paidSection);

                if (paidCredits.length === 0) {
                    const empty = document.createElement('div');
                    empty.style.cssText = 'text-align: center; padding: 20px; color: #16a34a;';
                    empty.textContent = '支払済みのクレジット支払いはありません';
                    list.appendChild(empty);
                } else {
                    paidCredits.forEach(entry => {
                        const index = this.entries.indexOf(entry);
                        const div = document.createElement('div');
                        div.className = 'list-item';
                        div.style.opacity = '0.6';
                        div.innerHTML = `
                            <div class="list-item-info">
                                <div class="list-item-date">${entry.date}</div>
                                <div class="list-item-category">${entry.category} <span class="badge">支払済</span></div>
                                ${entry.memo ? `<div class="list-item-memo">${entry.memo}</div>` : ''}
                            </div>
                            <div class="list-item-amount" style="color: #22c55e;">¥${entry.amount.toLocaleString()}</div>
                            <button class="btn btn-small" onclick="app.markAsUnpaid(${index})" style="background: rgba(239, 68, 68, 0.2);">未払いに戻す</button>
                        `;
                        list.appendChild(div);
                    });
                }
            },

            renderFinanceList() {
                const list = document.getElementById('financeList');
                const sorted = [...this.financeEntries].sort((a, b) => b.timestamp - a.timestamp);
                
                list.innerHTML = '';
                sorted.forEach((entry, i) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    const isInflow = entry.type === '借入';
                    div.innerHTML = `
                        <div class="list-item-info">
                            <div class="list-item-date">${entry.date}</div>
                            <div class="list-item-category">${entry.type}</div>
                            ${entry.memo ? `<div class="list-item-memo">${entry.memo}</div>` : ''}
                        </div>
                        <div class="list-item-amount" style="color: ${isInflow ? '#22c55e' : '#ef4444'}">
                            ${isInflow ? '+' : '-'}¥${entry.amount.toLocaleString()}
                        </div>
                        <button class="btn btn-small" onclick="app.deleteFinance(${i})">削除</button>
                    `;
                    list.appendChild(div);
                });
            },

            renderSummary() {
                const today = new Date();
                const thisMonth = today.toISOString().slice(0, 7);
                const monthlyEntries = this.entries.filter(e => e.date.startsWith(thisMonth));
                
                const income = monthlyEntries.filter(e => e.type === 'income').reduce((sum, e) => sum + e.amount, 0);
                const expense = monthlyEntries.filter(e => e.type === 'expense').reduce((sum, e) => sum + e.amount, 0);
                const profit = income - expense;
                
                document.getElementById('monthlyProfit').textContent = `¥${profit.toLocaleString()}`;
                
                // Calculate cash - 現在
                const todayStr = today.toISOString().split('T')[0];
                const currentIncome = this.entries.filter(e => e.type === 'income' && e.date <= todayStr).reduce((sum, e) => sum + e.amount, 0);
                const currentExpense = this.entries.filter(e => e.type === 'expense' && !e.isCredit && e.date <= todayStr).reduce((sum, e) => sum + e.amount, 0);
                
                // 財務活動（借入・返済）を現金に反映
                const currentBorrowing = this.financeEntries.filter(e => e.type === '借入' && e.date <= todayStr).reduce((sum, e) => sum + e.amount, 0);
                const currentRepayment = this.financeEntries.filter(e => (e.type === '返済' || e.type === 'クレジット引落') && e.date <= todayStr).reduce((sum, e) => sum + e.amount, 0);
                
                const cashCurrent = currentIncome + currentBorrowing - currentExpense - currentRepayment;
                
                // Calculate cash - 月末予測
                const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                const monthEndIncome = this.entries.filter(e => e.type === 'income' && e.date <= lastDayOfMonth).reduce((sum, e) => sum + e.amount, 0);
                const monthEndExpense = this.entries.filter(e => e.type === 'expense' && !e.isCredit && e.date <= lastDayOfMonth).reduce((sum, e) => sum + e.amount, 0);
                
                const monthEndBorrowing = this.financeEntries.filter(e => e.type === '借入' && e.date <= lastDayOfMonth).reduce((sum, e) => sum + e.amount, 0);
                const monthEndRepayment = this.financeEntries.filter(e => (e.type === '返済' || e.type === 'クレジット引落') && e.date <= lastDayOfMonth).reduce((sum, e) => sum + e.amount, 0);
                
                const cashEndOfMonth = monthEndIncome + monthEndBorrowing - monthEndExpense - monthEndRepayment;
                
                document.getElementById('cashBalanceCurrent').textContent = `¥${cashCurrent.toLocaleString()}`;
                document.getElementById('cashBalanceEndOfMonth').textContent = `¥${cashEndOfMonth.toLocaleString()}`;
                
                // Calculate unpaid credit (概要画面用) - renderCreditListと同じロジック
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                
                const unpaidCredits = this.entries.filter(e => e.isCredit && !e.creditPaid);
                const unpaidTotal = unpaidCredits.reduce((sum, e) => sum + e.amount, 0);
                
                // 締め日と引落日
                const { closingDay, paymentDay } = this.creditSettings;
                
                // 今月の引落対象期間（先月の締め日翌日〜今月の締め日）
                const currentPeriodStart = new Date(currentYear, currentMonth - 1, closingDay + 1);
                const currentPeriodEnd = new Date(currentYear, currentMonth, closingDay);
                
                const currentMonthPayment = unpaidCredits.filter(e => {
                    const date = new Date(e.date);
                    return date >= currentPeriodStart && date <= currentPeriodEnd;
                }).reduce((sum, e) => sum + e.amount, 0);
                
                // 引落日の表示
                const paymentDate = new Date(currentYear, currentMonth, paymentDay);
                const paymentDateStr = `${paymentDate.getMonth() + 1}/${paymentDate.getDate()}`;
                
                document.getElementById('creditBalance').textContent = `¥${unpaidTotal.toLocaleString()}`;
                document.getElementById('currentPaymentSchedule').textContent = `¥${currentMonthPayment.toLocaleString()}`;
                document.getElementById('paymentScheduleDate').textContent = `引落: ${paymentDateStr}`;
            },

            renderPL() {
                const content = document.getElementById('plContent');
                
                // Get current, last, and next month
                const now = new Date();
                const months = [
                    new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7),
                    now.toISOString().slice(0, 7),
                    new Date(now.getFullYear(), now.getMonth() + 1, 1).toISOString().slice(0, 7)
                ];
                const monthLabels = ['先月', '今月', '来月'];

                // Calculate data for each month
                const monthlyData = months.map(month => {
                    const entries = this.entries.filter(e => e.date.startsWith(month));
                    
                    const salary = entries.filter(e => e.category === '給与').reduce((sum, e) => sum + e.amount, 0);
                    const bonus = entries.filter(e => e.category === 'ボーナス').reduce((sum, e) => sum + e.amount, 0);
                    const otherIncome = entries.filter(e => e.type === 'income' && !['給与', 'ボーナス'].includes(e.category)).reduce((sum, e) => sum + e.amount, 0);
                    const totalIncome = salary + bonus + otherIncome;

                    const expenses = {
                        '食費': 0, '住居費': 0, '水道光熱費': 0, '通信費': 0,
                        '交通費': 0, '娯楽費': 0, '医療費': 0, 'その他支出': 0
                    };
                    entries.filter(e => e.type === 'expense').forEach(e => {
                        if (expenses.hasOwnProperty(e.category)) {
                            expenses[e.category] += e.amount;
                        } else {
                            expenses['その他支出'] += e.amount;
                        }
                    });
                    const totalExpense = Object.values(expenses).reduce((sum, val) => sum + val, 0);
                    
                    return {
                        salary, bonus, otherIncome, totalIncome,
                        expenses, totalExpense,
                        netProfit: totalIncome - totalExpense
                    };
                });

                // Generate chart
                const maxValue = Math.max(...monthlyData.map(d => Math.max(d.totalIncome, d.totalExpense)));
                const chartBars = monthlyData.map((data, i) => {
                    const incomeHeight = maxValue > 0 ? (data.totalIncome / maxValue * 100) : 0;
                    const expenseHeight = maxValue > 0 ? (data.totalExpense / maxValue * 100) : 0;
                    return `
                        <div class="bar-group">
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${incomeHeight}%; background: #22c55e;" title="収入: ¥${data.totalIncome.toLocaleString()}"></div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${expenseHeight}%; background: #ef4444;" title="支出: ¥${data.totalExpense.toLocaleString()}"></div>
                            </div>
                            <div class="bar-label">${monthLabels[i]}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <div class="summary-box">
                        <div class="summary-label">今月の純利益</div>
                        <div class="summary-value" style="color: ${monthlyData[1].netProfit >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].netProfit.toLocaleString()}</div>
                    </div>

                    <div class="chart-container">
                        <div style="text-align: center; font-size: 12px; margin-bottom: 10px; color: #16a34a;">
                            <span style="color: #22c55e;">■</span> 収入　
                            <span style="color: #ef4444;">■</span> 支出
                        </div>
                        <div class="chart-bars">${chartBars}</div>
                    </div>

                    <div class="section-header">収入</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">給与</span>
                        <span class="data-value">¥${monthlyData[0].salary.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].salary.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].salary.toLocaleString()}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">ボーナス</span>
                        <span class="data-value">¥${monthlyData[0].bonus.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].bonus.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].bonus.toLocaleString()}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">その他収入</span>
                        <span class="data-value">¥${monthlyData[0].otherIncome.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].otherIncome.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].otherIncome.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total">
                        <span class="data-label">収入合計</span>
                        <span class="data-value">¥${monthlyData[0].totalIncome.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].totalIncome.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].totalIncome.toLocaleString()}</span>
                    </div>

                    <div class="section-header">支出</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    ${Object.keys(monthlyData[0].expenses).map(cat => `
                        <div class="data-row">
                            <span class="data-label">${cat}</span>
                            <span class="data-value">¥${monthlyData[0].expenses[cat].toLocaleString()}</span>
                            <span class="data-value">¥${monthlyData[1].expenses[cat].toLocaleString()}</span>
                            <span class="data-value">¥${monthlyData[2].expenses[cat].toLocaleString()}</span>
                        </div>
                    `).join('')}
                    <div class="data-row section-total">
                        <span class="data-label">支出合計</span>
                        <span class="data-value">¥${monthlyData[0].totalExpense.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].totalExpense.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].totalExpense.toLocaleString()}</span>
                    </div>

                    <div class="data-row section-total" style="background: rgba(34, 197, 94, 0.25); margin-top: 15px;">
                        <span class="data-label" style="font-size: 16px;">純利益</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[0].netProfit >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[0].netProfit.toLocaleString()}</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[1].netProfit >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].netProfit.toLocaleString()}</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[2].netProfit >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[2].netProfit.toLocaleString()}</span>
                    </div>
                `;
            },

            renderBS() {
                const content = document.getElementById('bsContent');
                
                // Get current, last, and next month
                const now = new Date();
                const months = [
                    new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7),
                    now.toISOString().slice(0, 7),
                    new Date(now.getFullYear(), now.getMonth() + 1, 1).toISOString().slice(0, 7)
                ];
                const monthLabels = ['先月', '今月', '来月'];

                // Calculate data for each month (cumulative up to that month)
                const monthlyData = months.map((month, idx) => {
                    // Get all entries up to this month
                    const allEntries = this.entries.filter(e => e.date <= month + '-31');
                    const allFinance = this.financeEntries.filter(e => e.date <= month + '-31');
                    
                    const totalIncome = allEntries.filter(e => e.type === 'income').reduce((sum, e) => sum + e.amount, 0);
                    const cashExpense = allEntries.filter(e => e.type === 'expense' && !e.isCredit).reduce((sum, e) => sum + e.amount, 0);
                    const cash = totalIncome - cashExpense;

                    // クレジット未払金（支払済みでないもののみ）
                    const creditDebt = allEntries.filter(e => e.isCredit && !e.creditPaid).reduce((sum, e) => sum + e.amount, 0);
                    const borrowing = allFinance.filter(e => e.type === '借入').reduce((sum, e) => sum + e.amount, 0);
                    const repayment = allFinance.filter(e => e.type === '返済' || e.type === 'クレジット返済').reduce((sum, e) => sum + e.amount, 0);
                    const totalDebt = creditDebt + borrowing - repayment;

                    const totalExpense = allEntries.filter(e => e.type === 'expense').reduce((sum, e) => sum + e.amount, 0);
                    const netProfit = totalIncome - totalExpense;
                    const equity = cash - totalDebt;

                    return { cash, creditDebt, borrowing: borrowing - repayment, totalDebt, netProfit, equity };
                });

                // Generate chart
                const maxValue = Math.max(...monthlyData.map(d => Math.max(Math.abs(d.cash), Math.abs(d.totalDebt), Math.abs(d.equity))));
                const chartBars = monthlyData.map((data, i) => {
                    const assetHeight = maxValue > 0 ? (Math.abs(data.cash) / maxValue * 100) : 0;
                    const debtHeight = maxValue > 0 ? (Math.abs(data.totalDebt) / maxValue * 100) : 0;
                    const equityHeight = maxValue > 0 ? (Math.abs(data.equity) / maxValue * 100) : 0;
                    return `
                        <div class="bar-group">
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${assetHeight}%; background: #22c55e;" title="資産: ¥${data.cash.toLocaleString()}"></div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${debtHeight}%; background: #ef4444;" title="負債: ¥${data.totalDebt.toLocaleString()}"></div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${equityHeight}%; background: #3b82f6;" title="純資産: ¥${data.equity.toLocaleString()}"></div>
                            </div>
                            <div class="bar-label">${monthLabels[i]}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <div class="summary-box">
                        <div class="summary-label">現在の純資産</div>
                        <div class="summary-value" style="color: ${monthlyData[1].equity >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].equity.toLocaleString()}</div>
                    </div>

                    <div class="chart-container">
                        <div style="text-align: center; font-size: 12px; margin-bottom: 10px; color: #16a34a;">
                            <span style="color: #22c55e;">■</span> 資産　
                            <span style="color: #ef4444;">■</span> 負債　
                            <span style="color: #3b82f6;">■</span> 純資産
                        </div>
                        <div class="chart-bars">${chartBars}</div>
                    </div>

                    <div class="section-header">資産</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">現金・預金</span>
                        <span class="data-value">¥${monthlyData[0].cash.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].cash.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].cash.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total">
                        <span class="data-label">資産合計</span>
                        <span class="data-value">¥${monthlyData[0].cash.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].cash.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].cash.toLocaleString()}</span>
                    </div>

                    <div class="section-header">負債</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">クレジット未払金</span>
                        <span class="data-value">¥${monthlyData[0].creditDebt.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].creditDebt.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].creditDebt.toLocaleString()}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">借入金（純額）</span>
                        <span class="data-value">¥${monthlyData[0].borrowing.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].borrowing.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].borrowing.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total">
                        <span class="data-label">負債合計</span>
                        <span class="data-value">¥${monthlyData[0].totalDebt.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].totalDebt.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].totalDebt.toLocaleString()}</span>
                    </div>

                    <div class="section-header">純資産</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">資本金</span>
                        <span class="data-value">¥0</span>
                        <span class="data-value">¥0</span>
                        <span class="data-value">¥0</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">利益剰余金</span>
                        <span class="data-value">¥${monthlyData[0].netProfit.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].netProfit.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].netProfit.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total" style="background: rgba(34, 197, 94, 0.25);">
                        <span class="data-label">純資産合計</span>
                        <span class="data-value" style="color: ${monthlyData[0].equity >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[0].equity.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[1].equity >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].equity.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[2].equity >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[2].equity.toLocaleString()}</span>
                    </div>
                `;
            },

            renderCF() {
                const content = document.getElementById('cfContent');
                
                // Get current, last, and next month
                const now = new Date();
                const months = [
                    new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7),
                    now.toISOString().slice(0, 7),
                    new Date(now.getFullYear(), now.getMonth() + 1, 1).toISOString().slice(0, 7)
                ];
                const monthLabels = ['先月', '今月', '来月'];

                // Calculate data for each month
                const monthlyData = months.map(month => {
                    const income = this.entries.filter(e => e.type === 'income' && e.date.startsWith(month)).reduce((sum, e) => sum + e.amount, 0);
                    const cashExpense = this.entries.filter(e => e.type === 'expense' && !e.isCredit && e.date.startsWith(month)).reduce((sum, e) => sum + e.amount, 0);
                    const operatingCF = income - cashExpense;

                    const borrowing = this.financeEntries.filter(e => e.type === '借入' && e.date.startsWith(month)).reduce((sum, e) => sum + e.amount, 0);
                    const repayment = this.financeEntries.filter(e => (e.type === '返済' || e.type === 'クレジット返済') && e.date.startsWith(month)).reduce((sum, e) => sum + e.amount, 0);
                    const financingCF = borrowing - repayment;

                    const netCF = operatingCF + financingCF;

                    return { income, cashExpense, operatingCF, borrowing, repayment, financingCF, netCF };
                });

                // Generate chart
                const maxValue = Math.max(...monthlyData.map(d => Math.max(Math.abs(d.operatingCF), Math.abs(d.financingCF), Math.abs(d.netCF))));
                const chartBars = monthlyData.map((data, i) => {
                    const opHeight = maxValue > 0 ? (Math.abs(data.operatingCF) / maxValue * 100) : 0;
                    const finHeight = maxValue > 0 ? (Math.abs(data.financingCF) / maxValue * 100) : 0;
                    const netHeight = maxValue > 0 ? (Math.abs(data.netCF) / maxValue * 100) : 0;
                    return `
                        <div class="bar-group">
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${opHeight}%; background: ${data.operatingCF >= 0 ? '#22c55e' : '#ef4444'};" title="営業CF: ¥${data.operatingCF.toLocaleString()}"></div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${finHeight}%; background: ${data.financingCF >= 0 ? '#3b82f6' : '#f59e0b'};" title="財務CF: ¥${data.financingCF.toLocaleString()}"></div>
                            </div>
                            <div class="bar-wrapper">
                                <div class="bar" style="height: ${netHeight}%; background: ${data.netCF >= 0 ? '#22c55e' : '#ef4444'};" title="純CF: ¥${data.netCF.toLocaleString()}"></div>
                            </div>
                            <div class="bar-label">${monthLabels[i]}</div>
                        </div>
                    `;
                }).join('');

                content.innerHTML = `
                    <div class="summary-box">
                        <div class="summary-label">今月の現金増減</div>
                        <div class="summary-value" style="color: ${monthlyData[1].netCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].netCF.toLocaleString()}</div>
                    </div>

                    <div class="chart-container">
                        <div style="text-align: center; font-size: 12px; margin-bottom: 10px; color: #16a34a;">
                            営業CF　財務CF　純CF
                        </div>
                        <div class="chart-bars">${chartBars}</div>
                    </div>

                    <div class="section-header">営業活動によるキャッシュフロー</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">収入</span>
                        <span class="data-value">¥${monthlyData[0].income.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].income.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].income.toLocaleString()}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">支出（現金）</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[0].cashExpense.toLocaleString()}</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[1].cashExpense.toLocaleString()}</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[2].cashExpense.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total">
                        <span class="data-label">営業CF</span>
                        <span class="data-value" style="color: ${monthlyData[0].operatingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[0].operatingCF.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[1].operatingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].operatingCF.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[2].operatingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[2].operatingCF.toLocaleString()}</span>
                    </div>

                    <div class="section-header">財務活動によるキャッシュフロー</div>
                    <div class="data-row" style="font-weight: bold; border-bottom: 1px solid #166534; padding-bottom: 5px; margin-bottom: 5px;">
                        <span class="data-label"></span>
                        <span class="data-value">${monthLabels[0]}</span>
                        <span class="data-value">${monthLabels[1]}</span>
                        <span class="data-value">${monthLabels[2]}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">借入</span>
                        <span class="data-value">¥${monthlyData[0].borrowing.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[1].borrowing.toLocaleString()}</span>
                        <span class="data-value">¥${monthlyData[2].borrowing.toLocaleString()}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">返済</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[0].repayment.toLocaleString()}</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[1].repayment.toLocaleString()}</span>
                        <span class="data-value" style="color: #ef4444">-¥${monthlyData[2].repayment.toLocaleString()}</span>
                    </div>
                    <div class="data-row section-total">
                        <span class="data-label">財務CF</span>
                        <span class="data-value" style="color: ${monthlyData[0].financingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[0].financingCF.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[1].financingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].financingCF.toLocaleString()}</span>
                        <span class="data-value" style="color: ${monthlyData[2].financingCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[2].financingCF.toLocaleString()}</span>
                    </div>

                    <div class="data-row section-total" style="background: rgba(34, 197, 94, 0.25); margin-top: 15px;">
                        <span class="data-label" style="font-size: 16px;">現金増減額</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[0].netCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[0].netCF.toLocaleString()}</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[1].netCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[1].netCF.toLocaleString()}</span>
                        <span class="data-value" style="font-size: 16px; color: ${monthlyData[2].netCF >= 0 ? '#22c55e' : '#ef4444'}">¥${monthlyData[2].netCF.toLocaleString()}</span>
                    </div>
                `;
            },

            deleteEntry(index) {
                if (confirm('削除しますか？')) {
                    this.entries.splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },

            deleteFinance(index) {
                if (confirm('削除しますか？')) {
                    this.financeEntries.splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },

            // 定期支払い管理
            saveRecurring() {
                const name = document.getElementById('recurringName').value.trim();
                const category = document.getElementById('recurringCategory').value;
                const amount = parseFloat(document.getElementById('recurringAmount').value);
                const day = parseInt(document.getElementById('recurringDay').value);
                const isCredit = document.getElementById('recurringCredit').checked;

                if (!name || !amount || !day) {
                    alert('すべての項目を入力してください');
                    return;
                }

                if (day < 1 || day > 31) {
                    alert('支払日は1-31の範囲で入力してください');
                    return;
                }

                this.recurringPayments.push({
                    name,
                    category,
                    amount,
                    day,
                    isCredit,
                    timestamp: Date.now()
                });

                this.saveData();
                this.render();
                this.updateRecurringNameHistory();

                // Clear form
                document.getElementById('recurringName').value = '';
                document.getElementById('recurringAmount').value = '';
                document.getElementById('recurringDay').value = '';
                document.getElementById('recurringCredit').checked = false;

                alert('定期支払いを登録しました');
            },

            updateRecurringNameHistory() {
                const nameList = document.getElementById('recurringNameHistory');
                const names = [...new Set(this.recurringPayments.map(p => p.name))];
                nameList.innerHTML = names.map(n => `<option value="${n}">`).join('');
            },

            renderRecurringList() {
                const list = document.getElementById('recurringList');
                const sorted = [...this.recurringPayments].sort((a, b) => a.day - b.day);
                
                document.getElementById('recurringCount').textContent = sorted.length;
                
                list.innerHTML = '';
                
                if (sorted.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: #16a34a;">登録された定期支払いはありません</div>';
                    return;
                }

                sorted.forEach((payment, i) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="list-item-info">
                            <div style="font-weight: bold; margin-bottom: 5px;">${payment.name}</div>
                            <div class="list-item-category">
                                ${payment.category}
                                ${payment.isCredit ? '<span class="badge">CREDIT</span>' : ''}
                            </div>
                            <div class="list-item-memo">毎月${payment.day}日に自動追加</div>
                        </div>
                        <div class="list-item-amount">¥${payment.amount.toLocaleString()}</div>
                        <button class="btn btn-small" onclick="app.deleteRecurring(${i})">削除</button>
                    `;
                    list.appendChild(div);
                });
            },

            deleteRecurring(index) {
                if (confirm('この定期支払いを削除しますか？')) {
                    this.recurringPayments.splice(index, 1);
                    this.saveData();
                    this.render();
                }
            },

            generateRecurringPayments() {
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();
                const currentDay = today.getDate();

                this.recurringPayments.forEach(payment => {
                    // 今月の支払日
                    const paymentDate = new Date(currentYear, currentMonth, payment.day);
                    
                    // 支払日が今日以前で、まだ今月の支払いが登録されていない場合
                    if (payment.day <= currentDay) {
                        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(payment.day).padStart(2, '0')}`;
                        
                        // 重複チェック（同じ日付・カテゴリ・金額の支払いがないか）
                        const exists = this.entries.some(entry => 
                            entry.date === dateStr && 
                            entry.category === payment.category && 
                            entry.amount === payment.amount &&
                            entry.memo && entry.memo.includes(payment.name)
                        );

                        if (!exists) {
                            // 自動的に収支入力に追加
                            this.entries.push({
                                date: dateStr,
                                type: 'expense',
                                category: payment.category,
                                amount: payment.amount,
                                memo: `【${payment.name}】（定期支払い）`,
                                isCredit: payment.isCredit,
                                creditPaid: false,
                                timestamp: Date.now()
                            });
                        }
                    }
                });

                this.saveData();
            },

            markAsPaid(index) {
                if (confirm('この支払いを「支払済み」にしますか？')) {
                    this.entries[index].creditPaid = true;
                    this.saveData();
                    this.render();
                }
            },

            markAsUnpaid(index) {
                if (confirm('この支払いを「未払い」に戻しますか？')) {
                    this.entries[index].creditPaid = false;
                    this.saveData();
                    this.render();
                }
            },

            showCreditSettings() {
                document.getElementById('creditClosingDay').value = this.creditSettings.closingDay;
                document.getElementById('creditPaymentDayInput').value = this.creditSettings.paymentDay;
                document.getElementById('creditSettingsModal').classList.add('active');
            },

            closeCreditSettings() {
                document.getElementById('creditSettingsModal').classList.remove('active');
            },

            saveCreditSettings() {
                this.creditSettings.closingDay = parseInt(document.getElementById('creditClosingDay').value);
                this.creditSettings.paymentDay = parseInt(document.getElementById('creditPaymentDayInput').value);
                this.saveData();
                this.render();
                this.closeCreditSettings();
                alert('設定を保存しました');
            }
        };

        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
