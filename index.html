<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIP-BOY 3000 Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #22c55e;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            position: relative;
        }

        /* CRT overlay */
        .crt-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
            opacity: 0.1;
            background: repeating-linear-gradient(
                0deg,
                rgba(0,0,0,0.15) 0px,
                transparent 1px,
                transparent 2px,
                rgba(0,0,0,0.15) 3px
            );
        }

        /* Main terminal */
        .terminal {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #064e3b 0%, #000 100%);
            border: 8px solid #374151;
            border-radius: 8px;
            box-shadow: 0 0 60px rgba(34, 197, 94, 0.3), inset 0 0 40px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 30px;
        }

        /* Scanline effect */
        .scanline {
            position: absolute;
            inset: 0;
            pointer-events: none;
            opacity: 0.05;
            background: linear-gradient(transparent 50%, rgba(34, 197, 94, 0.3) 50%);
            background-size: 100% 4px;
            animation: scanline 8s linear infinite;
        }

        @keyframes scanline {
            0% { transform: translateY(0); }
            100% { transform: translateY(100%); }
        }

        /* Header */
        .header {
            border: 2px solid #22c55e;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
            z-index: 5;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 28px;
            font-weight: bold;
            letter-spacing: 2px;
            text-shadow: 0 0 10px #22c55e;
        }

        .datetime {
            text-align: right;
            font-size: 14px;
        }

        .datetime-date {
            margin-bottom: 3px;
        }

        .datetime-time {
            font-size: 20px;
            font-weight: bold;
        }

        .subtitle {
            text-align: center;
            font-size: 14px;
            border-top: 1px solid #16a34a;
            padding-top: 8px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .tab-btn {
            background: transparent;
            border: 1px solid #166534;
            color: #16a34a;
            font-family: inherit;
            font-size: 13px;
            padding: 5px 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .tab-btn.active {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        /* Main content */
        .main-content {
            flex: 1;
            display: flex;
            gap: 15px;
            overflow: hidden;
            position: relative;
            z-index: 5;
        }

        /* Entries list */
        .entries-panel {
            width: 30%;
            border: 2px solid #22c55e;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .entries-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #16a34a;
        }

        .entries-title {
            font-size: 13px;
            font-weight: bold;
        }

        .btn-new {
            padding: 5px 10px;
            border: 1px solid #22c55e;
            background: transparent;
            color: #22c55e;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-new:hover {
            background: #22c55e;
            color: #000;
        }

        .filter-btn {
            flex: 1;
            padding: 4px 8px;
            border: 1px solid #166534;
            background: transparent;
            color: #16a34a;
            font-family: inherit;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .filter-btn.active {
            border-color: #22c55e;
            color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }

        .entries-list {
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #22c55e #000;
        }

        .entries-list::-webkit-scrollbar {
            width: 6px;
        }

        .entries-list::-webkit-scrollbar-track {
            background: #000;
        }

        .entries-list::-webkit-scrollbar-thumb {
            background: #22c55e;
        }

        .entry-item {
            padding: 12px;
            border: 1px solid #166534;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .entry-item:hover {
            border-color: #22c55e;
        }

        .entry-item.selected {
            border-color: #86efac;
            background: rgba(34, 197, 94, 0.2);
        }

        .entry-date {
            font-size: 11px;
            margin-bottom: 5px;
        }

        .entry-preview {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Editor */
        .editor-panel {
            flex: 1;
            border: 2px solid #22c55e;
            background: rgba(0,0,0,0.6);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        .editor-header {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #16a34a;
        }

        .editor-textarea {
            flex: 1;
            background: transparent;
            border: 1px solid #166534;
            padding: 15px;
            resize: none;
            color: #22c55e;
            font-family: inherit;
            font-size: 15px;
            line-height: 1.6;
            outline: none;
            text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
        }

        .task-input {
            background: transparent;
            border: 1px solid #166534;
            padding: 12px 15px;
            color: #22c55e;
            font-family: inherit;
            font-size: 16px;
            font-weight: bold;
            outline: none;
            text-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
            margin-bottom: 10px;
        }

        .task-input:focus {
            border-color: #22c55e;
        }

        .task-input::placeholder {
            color: #166534;
        }

        .task-input[type="date"] {
            color-scheme: dark;
        }

        .task-input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.6) sepia(1) saturate(5) hue-rotate(90deg);
            cursor: pointer;
        }

        select.task-input {
            cursor: pointer;
            background-image: linear-gradient(45deg, transparent 50%, #22c55e 50%), linear-gradient(135deg, #22c55e 50%, transparent 50%);
            background-position: calc(100% - 20px) calc(1em), calc(100% - 15px) calc(1em);
            background-size: 5px 5px, 5px 5px;
            background-repeat: no-repeat;
            padding-right: 35px;
        }

        select.task-input option {
            background: #000;
            color: #22c55e;
        }

        select.task-input optgroup {
            background: #064e3b;
            color: #86efac;
            font-weight: bold;
        }

        .task-item {
            padding: 12px;
            border: 1px solid #166534;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .task-item:hover {
            border-color: #22c55e;
        }

        .task-item.selected {
            border-color: #86efac;
            background: rgba(34, 197, 94, 0.2);
        }

        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }

        .task-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #22c55e;
            background: transparent;
            cursor: pointer;
            flex-shrink: 0;
            margin-top: 2px;
            position: relative;
        }

        .task-checkbox.checked::after {
            content: '✓';
            position: absolute;
            top: -4px;
            left: 1px;
            color: #22c55e;
            font-size: 14px;
            font-weight: bold;
        }

        .task-content {
            flex: 1;
        }

        .task-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .task-desc {
            font-size: 11px;
            color: #16a34a;
        }

        .task-mission-badge {
            font-size: 9px;
            color: #3b82f6;
            border: 1px solid #3b82f6;
            padding: 2px 6px;
            margin-top: 4px;
            display: inline-block;
        }

        .mission-task-item {
            padding: 10px;
            border: 1px solid #166534;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.3);
        }

        .mission-task-item.completed {
            opacity: 0.6;
        }

        .mission-task-order {
            width: 24px;
            height: 24px;
            border: 2px solid #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .mission-task-content {
            flex: 1;
        }

        .mission-task-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .mission-task-desc {
            font-size: 11px;
            color: #16a34a;
        }

        .mission-task-remove {
            padding: 6px 12px;
            border: 1px solid #dc2626;
            background: transparent;
            color: #dc2626;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mission-task-remove:hover {
            background: #dc2626;
            color: #000;
        }

        .mission-item {
            padding: 12px;
            border: 1px solid #166534;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mission-item:hover {
            border-color: #22c55e;
        }

        .mission-item.selected {
            border-color: #86efac;
            background: rgba(34, 197, 94, 0.2);
        }

        .mission-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .mission-progress {
            font-size: 11px;
            color: #16a34a;
            margin-bottom: 3px;
        }

        .mission-deadline {
            font-size: 10px;
            color: #22c55e;
        }

        .mission-deadline.overdue {
            color: #dc2626;
        }

        .editor-textarea:focus {
            border-color: #22c55e;
        }

        .editor-textarea::placeholder {
            color: #166534;
        }

        .editor-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px;
            border: 2px solid #22c55e;
            background: transparent;
            color: #22c55e;
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover:not(:disabled) {
            background: #22c55e;
            color: #000;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-delete {
            flex: 0 0 auto;
            padding: 10px 18px;
            border-color: #dc2626;
            color: #dc2626;
        }

        .btn-delete:hover {
            background: #dc2626;
            color: #000;
        }

        .btn-sync {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .btn-sync:hover {
            background: #3b82f6;
            color: #000;
        }

        /* Footer */
        .footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #16a34a;
            text-align: center;
            font-size: 11px;
            color: #16a34a;
            position: relative;
            z-index: 5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 100%;
            max-width: 700px;
            max-height: 90vh;
            background: linear-gradient(135deg, #064e3b 0%, #000 100%);
            border: 8px solid #374151;
            border-radius: 8px;
            box-shadow: 0 0 80px rgba(34, 197, 94, 0.5);
            padding: 30px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #22c55e;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 0 10px #22c55e;
        }

        .modal-date {
            font-size: 12px;
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            border: 2px solid #22c55e;
            background: rgba(0,0,0,0.6);
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .modal-close {
            margin-top: 20px;
            padding: 12px;
            border: 2px solid #22c55e;
            background: transparent;
            color: #22c55e;
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #22c55e;
            color: #000;
        }

        /* Settings modal */
        .settings-content {
            width: 100%;
            max-width: 500px;
        }

        .settings-input {
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            border: 2px solid #22c55e;
            color: #22c55e;
            font-family: inherit;
            font-size: 13px;
            margin: 15px 0;
        }

        .settings-help {
            font-size: 11px;
            color: #16a34a;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .typing-cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background: #22c55e;
            margin-left: 2px;
            animation: blink 0.7s infinite;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                height: 95vh;
            }

            .title {
                font-size: 18px;
            }

            .main-content {
                flex-direction: column;
            }

            .entries-panel {
                width: 100%;
                height: 35%;
            }

            .editor-panel {
                height: 65%;
            }

            .terminal {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="crt-overlay"></div>
        <div class="terminal">
            <div class="scanline"></div>

            <!-- Header -->
            <div class="header">
                <div class="header-top">
                    <div class="title">PIP-BOY 3000 Mk.IV</div>
                    <div class="datetime">
                        <div class="datetime-date" id="currentDate"></div>
                        <div class="datetime-time" id="currentTime"></div>
                    </div>
                </div>
                <div class="subtitle">
                    <button class="tab-btn active" onclick="app.switchTab('journal')">&gt;&gt;&gt; JOURNAL &lt;&lt;&lt;</button>
                    <button class="tab-btn" onclick="app.switchTab('tasks')">&gt;&gt;&gt; TASKS &lt;&lt;&lt;</button>
                    <button class="tab-btn" onclick="app.switchTab('missions')">&gt;&gt;&gt; MISSIONS &lt;&lt;&lt;</button>
                    <button class="tab-btn" onclick="app.switchTab('budget')">&gt;&gt;&gt; BUDGET &lt;&lt;&lt;</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content" id="journalContent">
                <!-- Entries List -->
                <div class="entries-panel">
                    <div class="entries-header">
                        <span class="entries-title">ENTRIES [<span id="entryCount">0</span>]</span>
                        <button class="btn-new" onclick="app.newEntry()">+ NEW</button>
                    </div>
                    <div class="entries-list" id="entriesList"></div>
                </div>

                <!-- Editor -->
                <div class="editor-panel">
                    <div class="editor-header" id="editorHeader">NEW ENTRY</div>
                    <textarea 
                        class="editor-textarea" 
                        id="editorText" 
                        placeholder="Enter journal entry..."
                    ></textarea>
                    <div class="editor-buttons">
                        <button class="btn" onclick="app.saveEntry()" id="btnSave">SAVE</button>
                        <button class="btn btn-sync" onclick="app.syncData()" id="btnSync">SYNC</button>
                        <button class="btn btn-delete" onclick="app.deleteEntry()" id="btnDelete" style="display:none;">DEL</button>
                    </div>
                </div>
            </div>

            <!-- Task Content -->
            <div class="main-content" id="taskContent" style="display:none;">
                <!-- Task List -->
                <div class="entries-panel">
                    <div class="entries-header">
                        <span class="entries-title">TASKS [<span id="taskCount">0</span>]</span>
                        <button class="btn-new" onclick="app.newTask()">+ NEW</button>
                    </div>
                    <div style="display: flex; gap: 5px; padding: 8px; border-bottom: 1px solid #166534; font-size: 10px;">
                        <button class="filter-btn active" onclick="app.setTaskFilter('all')">ALL</button>
                        <button class="filter-btn" onclick="app.setTaskFilter('standalone')">STANDALONE</button>
                        <button class="filter-btn" onclick="app.setTaskFilter('mission')">MISSION</button>
                    </div>
                    <div class="entries-list" id="tasksList"></div>
                </div>

                <!-- Task Editor -->
                <div class="editor-panel">
                    <div class="editor-header" id="taskEditorHeader">NEW TASK</div>
                    <input 
                        type="text"
                        class="task-input" 
                        id="taskTitle" 
                        placeholder="Task title..."
                    />
                    <textarea 
                        class="editor-textarea" 
                        id="taskDescription" 
                        placeholder="Task description (optional)..."
                        style="flex: 1;"
                    ></textarea>
                    <div class="editor-buttons">
                        <button class="btn" onclick="app.saveTask()" id="btnSaveTask">SAVE</button>
                        <button class="btn btn-delete" onclick="app.deleteTask()" id="btnDeleteTask" style="display:none;">DEL</button>
                    </div>
                </div>
            </div>

            <!-- Mission Content -->
            <div class="main-content" id="missionContent" style="display:none;">
                <!-- Mission List -->
                <div class="entries-panel">
                    <div class="entries-header">
                        <span class="entries-title">MISSIONS [<span id="missionCount">0</span>]</span>
                        <button class="btn-new" onclick="app.newMission()">+ NEW</button>
                    </div>
                    <div class="entries-list" id="missionsList"></div>
                </div>

                <!-- Mission Editor -->
                <div class="editor-panel" id="missionEditor" style="display:flex;">
                    <div class="editor-header" id="missionEditorHeader">NEW MISSION</div>
                    <input 
                        type="text"
                        class="task-input" 
                        id="missionTitle" 
                        placeholder="Mission title..."
                    />
                    <textarea 
                        class="editor-textarea" 
                        id="missionDescription" 
                        placeholder="Mission description..."
                        style="flex: 0 0 80px;"
                    ></textarea>
                    <div style="margin: 10px 0;">
                        <label style="font-size: 12px; margin-bottom: 5px; display: block;">DEADLINE:</label>
                        <input 
                            type="date"
                            class="task-input" 
                            id="missionDeadline"
                            style="margin-bottom: 0;"
                        />
                    </div>
                    <div style="flex: 1; border: 1px solid #166534; padding: 10px; margin: 10px 0; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #16a34a;">
                            <span style="font-size: 12px; font-weight: bold;">WORKFLOW TASKS</span>
                            <button class="btn-new" onclick="app.addMissionTask()">+ ADD</button>
                        </div>
                        <div id="missionTasksList"></div>
                    </div>
                    <div class="editor-buttons">
                        <button class="btn" onclick="app.saveMission()" id="btnSaveMission">SAVE</button>
                        <button class="btn btn-delete" onclick="app.deleteMission()" id="btnDeleteMission" style="display:none;">DEL</button>
                    </div>
                </div>

                <!-- Mission Viewer -->
                <div class="editor-panel" id="missionViewer" style="display:none;">
                    <div class="editor-header" id="missionViewerHeader"></div>
                    <div style="padding: 15px; border: 1px solid #166534; background: rgba(0,0,0,0.3); margin-bottom: 10px;">
                        <div style="font-size: 13px; margin-bottom: 10px; line-height: 1.6;" id="missionViewDescription"></div>
                        <div style="font-size: 12px; color: #16a34a;" id="missionViewDeadline"></div>
                    </div>
                    <div style="flex: 1; border: 1px solid #166534; padding: 15px; overflow-y: auto;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #16a34a;">
                            WORKFLOW TASKS (<span id="missionProgress">0/0</span>)
                        </div>
                        <div id="missionViewTasksList"></div>
                    </div>
                    <div class="editor-buttons">
                        <button class="btn" onclick="app.editMissionFromViewer()">EDIT</button>
                        <button class="btn btn-delete" onclick="app.closeMissionViewer()">CLOSE</button>
                    </div>
                </div>
            </div>

            <!-- Budget Content -->
            <div class="main-content" id="budgetContent" style="display:none;">
                <!-- Single centered panel for dashboard link -->
                <div style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%;">
                    <div style="text-align: center; max-width: 600px; padding: 40px;">
                        <div style="font-size: 24px; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; text-shadow: 0 0 10px #22c55e;">
                            &gt;&gt;&gt; 財務管理システム &lt;&lt;&lt;
                        </div>
                        <div style="font-size: 12px; color: #16a34a; margin-bottom: 30px; line-height: 1.8;">
                            高度な財務管理機能を利用するには<br>
                            財務ダッシュボードを開いてください
                        </div>
                        <a href="financial-dashboard.html" target="_blank" style="display: block; text-decoration: none;">
                            <button class="btn" style="width: 100%; padding: 20px; font-size: 16px; background: rgba(34, 197, 94, 0.2); border: 2px solid #22c55e;">
                                &gt;&gt;&gt; OPEN FINANCIAL DASHBOARD &lt;&lt;&lt;
                            </button>
                        </a>
                        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #166534;">
                            <div style="font-size: 10px; color: #16a34a; margin-bottom: 10px;">利用可能な機能:</div>
                            <div style="font-size: 11px; color: #22c55e; line-height: 1.8;">
                                ✓ 損益計算書 (P/L)<br>
                                ✓ 貸借対照表 (B/S)<br>
                                ✓ キャッシュフロー計算書 (C/F)<br>
                                ✓ 収支入力・管理<br>
                                ✓ クレジットカード管理<br>
                                ✓ 借入・返済管理<br>
                                ✓ 定期支払い自動生成<br>
                                ✓ GitHub同期
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                VAULT-TEC APPROVED | RADIATION LEVEL: SAFE | SYSTEM STATUS: OPERATIONAL
            </div>
        </div>
    </div>

    <!-- View Entry Modal -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ENTRY VIEWER</div>
                <div class="modal-date" id="modalDate"></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <button class="modal-close" onclick="app.closeModal()">[ CLOSE ]</button>
        </div>
    </div>

    <!-- View Task Modal -->
    <div class="modal" id="viewTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">TASK VIEWER</div>
            </div>
            <div class="modal-body">
                <div style="font-size: 18px; font-weight: bold; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #22c55e;" id="taskModalTitle"></div>
                <div id="taskModalBody"></div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="modal-close" style="flex: 1;" onclick="app.editTaskFromModal()">[ EDIT ]</button>
                <button class="modal-close" style="flex: 1;" onclick="app.closeTaskModal()">[ CLOSE ]</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content settings-content">
            <div class="modal-header">
                <div class="modal-title">GITHUB GIST SETTINGS</div>
            </div>
            <div class="modal-body">
                <div class="settings-help">
                    GitHub Gistでデータを同期するには、Personal Access Tokenが必要です。<br>
                    1. GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)<br>
                    2. "Generate new token (classic)" をクリック<br>
                    3. "gist" にチェックを入れて生成<br>
                    4. 生成されたトークンを下に貼り付け
                </div>
                <input 
                    type="password" 
                    class="settings-input" 
                    id="githubToken" 
                    placeholder="GitHub Personal Access Token"
                />
                <input 
                    type="text" 
                    class="settings-input" 
                    id="gistId" 
                    placeholder="Gist ID (初回は空欄でOK)"
                />
            </div>
            <button class="modal-close" onclick="app.saveSettings()">[ SAVE & SYNC ]</button>
        </div>
    </div>

    <script>
        const app = {
            entries: [],
            tasks: [],
            missions: [],
            transactions: [],
            currentEntry: null,
            currentTask: null,
            currentMission: null,
            currentTransaction: null,
            currentViewedTask: null,
            currentTab: 'journal',
            taskFilter: 'all', // all, standalone, mission
            budgetView: 'list', // list, summary
            transactionType: 'expense', // income, expense
            githubToken: localStorage.getItem('githubToken') || '',
            gistId: localStorage.getItem('gistId') || '',
            typingSpeed: 30, // ミリ秒（速度調整可能）
            audioContext: null,

            init() {
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
                this.loadLocalData();
                this.render();

                // Audio Context初期化（ユーザー操作後に初期化）
                document.addEventListener('click', () => {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                }, { once: true });

                // 初回起動時に設定モーダルを表示
                if (!this.githubToken) {
                    document.getElementById('settingsModal').classList.add('active');
                }
            },

            playPipSound() {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // 低めの周波数でPip-Boy風の重厚な音
                oscillator.frequency.value = 280; // 280Hz（低め）
                oscillator.type = 'square'; // 矩形波でレトロな音質

                // 音量エンベロープ（短く鋭い音）
                const now = this.audioContext.currentTime;
                gainNode.gain.setValueAtTime(0.08, now); // 音量を小さめに
                gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.05);

                oscillator.start(now);
                oscillator.stop(now + 0.05);
            },

            switchTab(tab) {
                this.currentTab = tab;
                
                // タブボタンの表示切り替え
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                // コンテンツの表示切り替え
                const journalContent = document.getElementById('journalContent');
                const taskContent = document.getElementById('taskContent');
                const missionContent = document.getElementById('missionContent');
                const budgetContent = document.getElementById('budgetContent');
                
                if (journalContent) journalContent.style.display = 'none';
                if (taskContent) taskContent.style.display = 'none';
                if (missionContent) missionContent.style.display = 'none';
                if (budgetContent) budgetContent.style.display = 'none';
                
                if (tab === 'journal' && journalContent) {
                    journalContent.style.display = 'flex';
                } else if (tab === 'tasks' && taskContent) {
                    taskContent.style.display = 'flex';
                } else if (tab === 'missions' && missionContent) {
                    missionContent.style.display = 'flex';
                } else if (tab === 'budget' && budgetContent) {
                    budgetContent.style.display = 'flex';
                }
            },

            updateDateTime() {
                const now = new Date();
                const date = `${now.getFullYear()}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
                const time = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
                document.getElementById('currentDate').textContent = date;
                document.getElementById('currentTime').textContent = time;
            },

            loadLocalData() {
                const saved = localStorage.getItem('journalEntries');
                if (saved) {
                    this.entries = JSON.parse(saved);
                    this.entries.sort((a, b) => b.timestamp - a.timestamp);
                }

                const savedTasks = localStorage.getItem('tasks');
                if (savedTasks) {
                    this.tasks = JSON.parse(savedTasks);
                    this.tasks.sort((a, b) => a.completed - b.completed || b.timestamp - a.timestamp);
                }

                const savedMissions = localStorage.getItem('missions');
                if (savedMissions) {
                    this.missions = JSON.parse(savedMissions);
                    this.missions.sort((a, b) => b.timestamp - a.timestamp);
                }

                const savedTransactions = localStorage.getItem('transactions');
                if (savedTransactions) {
                    this.transactions = JSON.parse(savedTransactions);
                    this.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                }
            },

            saveLocalData() {
                localStorage.setItem('journalEntries', JSON.stringify(this.entries));
                localStorage.setItem('tasks', JSON.stringify(this.tasks));
                localStorage.setItem('missions', JSON.stringify(this.missions));
                localStorage.setItem('transactions', JSON.stringify(this.transactions));
            },

            render() {
                this.renderEntries();
                this.renderTasks();
                this.renderMissions();
                this.renderTransactions();
            },

            renderEntries() {
                const list = document.getElementById('entriesList');
                list.innerHTML = '';
                
                this.entries.forEach((entry, index) => {
                    const div = document.createElement('div');
                    div.className = 'entry-item' + (this.currentEntry === entry ? ' selected' : '');
                    div.onclick = () => this.viewEntry(entry);
                    
                    const date = new Date(entry.timestamp);
                    const dateStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    div.innerHTML = `
                        <div class="entry-date">${dateStr}</div>
                        <div class="entry-preview">${entry.text.substring(0, 40)}...</div>
                    `;
                    list.appendChild(div);
                });

                document.getElementById('entryCount').textContent = this.entries.length;
            },

            renderTasks() {
                const list = document.getElementById('tasksList');
                list.innerHTML = '';
                
                // スタンドアロンタスクを収集
                const standaloneTasks = this.tasks.map(task => ({
                    ...task,
                    isMissionTask: false,
                    missionTitle: null
                }));
                
                // ミッション付随タスクを収集
                const missionTasks = [];
                this.missions.forEach(mission => {
                    mission.tasks.forEach(task => {
                        missionTasks.push({
                            ...task,
                            isMissionTask: true,
                            missionTitle: mission.title,
                            missionId: mission.id
                        });
                    });
                });
                
                // フィルター適用
                let allTasks = [...standaloneTasks, ...missionTasks];
                if (this.taskFilter === 'standalone') {
                    allTasks = standaloneTasks;
                } else if (this.taskFilter === 'mission') {
                    allTasks = missionTasks;
                }
                
                // ソート（未完了 → 完了）
                allTasks.sort((a, b) => a.completed - b.completed);
                
                allTasks.forEach((task) => {
                    const div = document.createElement('div');
                    div.className = 'task-item' + (task.completed ? ' completed' : '');
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'task-checkbox' + (task.completed ? ' checked' : '');
                    checkbox.onclick = (e) => {
                        e.stopPropagation();
                        if (task.isMissionTask) {
                            this.toggleMissionTask(task.missionId, task.id);
                        } else {
                            this.toggleTask(task.id);
                        }
                    };
                    
                    const content = document.createElement('div');
                    content.className = 'task-content';
                    content.onclick = () => {
                        if (task.isMissionTask) {
                            this.viewMissionTask(task);
                        } else {
                            this.viewTask(task);
                        }
                    };
                    
                    const title = document.createElement('div');
                    title.className = 'task-title';
                    title.textContent = task.title;
                    
                    content.appendChild(title);
                    
                    if (task.description) {
                        const desc = document.createElement('div');
                        desc.className = 'task-desc';
                        desc.textContent = task.description.substring(0, 50) + (task.description.length > 50 ? '...' : '');
                        content.appendChild(desc);
                    }
                    
                    if (task.isMissionTask) {
                        const badge = document.createElement('div');
                        badge.className = 'task-mission-badge';
                        badge.textContent = `MISSION: ${task.missionTitle}`;
                        content.appendChild(badge);
                    }
                    
                    div.appendChild(checkbox);
                    div.appendChild(content);
                    list.appendChild(div);
                });

                // カウント表示（フィルターに応じて）
                document.getElementById('taskCount').textContent = allTasks.length;
            },

            setTaskFilter(filter) {
                this.taskFilter = filter;
                
                // ボタンのアクティブ状態を更新
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.renderTasks();
            },

            toggleMissionTask(missionId, taskId) {
                const mission = this.missions.find(m => m.id === missionId);
                if (mission) {
                    const task = mission.tasks.find(t => t.id === taskId);
                    if (task) {
                        task.completed = !task.completed;
                        this.saveLocalData();
                        this.renderTasks();
                        this.renderMissions();

                        // 自動同期
                        if (this.githubToken && this.gistId) {
                            this.syncData();
                        }
                    }
                }
            },

            viewMissionTask(task) {
                const modal = document.getElementById('viewTaskModal');
                const titleEl = document.getElementById('taskModalTitle');
                const bodyEl = document.getElementById('taskModalBody');

                this.currentViewedMissionTask = task; // ミッションタスクを保存

                titleEl.textContent = task.title + ` [${task.missionTitle}]`;
                bodyEl.textContent = '';
                modal.classList.add('active');

                // タイピングエフェクト
                if (task.description) {
                    this.typeText(task.description, bodyEl);
                } else {
                    bodyEl.textContent = '(説明なし)';
                    bodyEl.style.color = '#16a34a';
                    bodyEl.style.fontStyle = 'italic';
                }
            },

            newEntry() {
                this.currentEntry = null;
                const editorText = document.getElementById('editorText');
                const editorHeader = document.getElementById('editorHeader');
                const btnDelete = document.getElementById('btnDelete');
                const btnSave = document.getElementById('btnSave');
                
                if (editorText) editorText.value = '';
                if (editorHeader) editorHeader.textContent = 'NEW ENTRY';
                if (btnDelete) btnDelete.style.display = 'none';
                if (btnSave) btnSave.disabled = false;
                this.render();
            },

            saveEntry() {
                const text = document.getElementById('editorText').value.trim();
                if (!text) return;

                const entry = {
                    id: Date.now().toString(),
                    text: text,
                    timestamp: Date.now()
                };

                this.entries.unshift(entry);
                this.saveLocalData();
                this.newEntry();
                this.render();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            async viewEntry(entry) {
                const modal = document.getElementById('viewModal');
                const body = document.getElementById('modalBody');
                const dateEl = document.getElementById('modalDate');

                const date = new Date(entry.timestamp);
                const dateStr = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                dateEl.textContent = dateStr;

                body.textContent = '';
                modal.classList.add('active');

                // タイピングエフェクト
                await this.typeText(entry.text, body);
            },

            async typeText(text, element) {
                element.textContent = '';
                for (let i = 0; i < text.length; i++) {
                    element.textContent += text[i];
                    
                    // 文字が表示されたらピッ音を鳴らす（スペースと改行以外）
                    if (text[i] !== ' ' && text[i] !== '\n' && text[i] !== '\r') {
                        this.playPipSound();
                    }
                    
                    if (i < text.length - 1) {
                        let delay = this.typingSpeed;
                        
                        // 句点やピリオドの後は15倍の間
                        if (text[i] === '。' || text[i] === '.' || text[i] === '!' || text[i] === '?') {
                            delay = this.typingSpeed * 15;
                        }
                        // 読点、カンマ、中点の後は4倍の間
                        else if (text[i] === '、' || text[i] === ',' || text[i] === '・') {
                            delay = this.typingSpeed * 4;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            },

            closeModal() {
                document.getElementById('viewModal').classList.remove('active');
            },

            newTask() {
                this.currentTask = null;
                const taskTitle = document.getElementById('taskTitle');
                const taskDescription = document.getElementById('taskDescription');
                const taskEditorHeader = document.getElementById('taskEditorHeader');
                const btnDeleteTask = document.getElementById('btnDeleteTask');
                
                if (taskTitle) taskTitle.value = '';
                if (taskDescription) taskDescription.value = '';
                if (taskEditorHeader) taskEditorHeader.textContent = 'NEW TASK';
                if (btnDeleteTask) btnDeleteTask.style.display = 'none';
                this.renderTasks();
            },

            saveTask() {
                const title = document.getElementById('taskTitle').value.trim();
                const description = document.getElementById('taskDescription').value.trim();
                
                if (!title) return;

                if (this.currentTask) {
                    // 既存タスクの更新
                    this.currentTask.title = title;
                    this.currentTask.description = description;
                } else {
                    // 新規タスク
                    const task = {
                        id: Date.now().toString(),
                        title: title,
                        description: description,
                        completed: false,
                        timestamp: Date.now()
                    };
                    this.tasks.push(task);
                }

                this.saveLocalData();
                this.newTask();
                this.renderTasks();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            editTask(task) {
                this.currentTask = task;
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskEditorHeader').textContent = 'EDIT TASK';
                document.getElementById('btnDeleteTask').style.display = 'block';
                this.renderTasks();
            },

            async viewTask(task) {
                const modal = document.getElementById('viewTaskModal');
                const titleEl = document.getElementById('taskModalTitle');
                const bodyEl = document.getElementById('taskModalBody');

                this.currentViewedTask = task; // 表示中のタスクを保存

                titleEl.textContent = task.title;
                bodyEl.textContent = '';
                modal.classList.add('active');

                // タイピングエフェクト
                if (task.description) {
                    await this.typeText(task.description, bodyEl);
                } else {
                    bodyEl.textContent = '(説明なし)';
                    bodyEl.style.color = '#16a34a';
                    bodyEl.style.fontStyle = 'italic';
                }
            },

            editTaskFromModal() {
                this.closeTaskModal();
                
                // ミッションタスクの場合はミッション編集画面へ
                if (this.currentViewedMissionTask) {
                    const mission = this.missions.find(m => m.id === this.currentViewedMissionTask.missionId);
                    if (mission) {
                        // MISSIONSタブに切り替え
                        this.switchTab('missions');
                        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                        document.querySelectorAll('.tab-btn')[2].classList.add('active');
                        
                        // ミッションを編集モードで開く
                        this.currentMission = mission;
                        this.editMissionFromViewer();
                    }
                } else if (this.currentViewedTask) {
                    // 通常のタスク編集
                    this.editTask(this.currentViewedTask);
                }
            },

            closeTaskModal() {
                document.getElementById('viewTaskModal').classList.remove('active');
                this.currentViewedTask = null;
                this.currentViewedMissionTask = null;
            },

            toggleTask(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    this.saveLocalData();
                    this.renderTasks();

                    // 自動同期
                    if (this.githubToken && this.gistId) {
                        this.syncData();
                    }
                }
            },

            // ========== Mission Management ==========

            renderMissions() {
                const list = document.getElementById('missionsList');
                list.innerHTML = '';
                
                this.missions.forEach(mission => {
                    const div = document.createElement('div');
                    div.className = 'mission-item' + (this.currentMission === mission ? ' selected' : '');
                    div.onclick = () => this.viewMission(mission);
                    
                    const completedCount = mission.tasks.filter(t => t.completed).length;
                    const totalCount = mission.tasks.length;
                    
                    const title = document.createElement('div');
                    title.className = 'mission-title';
                    title.textContent = mission.title;
                    
                    const progress = document.createElement('div');
                    progress.className = 'mission-progress';
                    progress.textContent = `Progress: ${completedCount}/${totalCount} tasks`;
                    
                    const deadline = document.createElement('div');
                    const deadlineDate = new Date(mission.deadline);
                    const today = new Date();
                    const isOverdue = deadlineDate < today && completedCount < totalCount;
                    deadline.className = 'mission-deadline' + (isOverdue ? ' overdue' : '');
                    deadline.textContent = `Deadline: ${mission.deadline}`;
                    
                    div.appendChild(title);
                    div.appendChild(progress);
                    div.appendChild(deadline);
                    list.appendChild(div);
                });

                document.getElementById('missionCount').textContent = this.missions.length;
            },

            newMission() {
                this.currentMission = null;
                document.getElementById('missionTitle').value = '';
                document.getElementById('missionDescription').value = '';
                document.getElementById('missionDeadline').value = '';
                document.getElementById('missionTasksList').innerHTML = '';
                document.getElementById('missionEditorHeader').textContent = 'NEW MISSION';
                document.getElementById('btnDeleteMission').style.display = 'none';
                document.getElementById('missionEditor').style.display = 'flex';
                document.getElementById('missionViewer').style.display = 'none';
                this.renderMissions();
            },

            addMissionTask() {
                const tasksList = document.getElementById('missionTasksList');
                const order = tasksList.children.length + 1;
                
                const div = document.createElement('div');
                div.className = 'mission-task-item';
                div.style.display = 'block';
                div.style.padding = '15px';
                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div class="mission-task-order">${order}</div>
                        <button class="mission-task-remove" onclick="this.parentElement.parentElement.remove(); app.reorderMissionTasks();">REMOVE</button>
                    </div>
                    <input type="text" class="task-input" placeholder="Task title..." style="margin-bottom: 8px; width: 100%;" />
                    <textarea class="editor-textarea" placeholder="Description (optional)..." style="height: 80px; font-size: 13px; padding: 10px; width: 100%; resize: vertical;"></textarea>
                `;
                tasksList.appendChild(div);
            },

            reorderMissionTasks() {
                const tasksList = document.getElementById('missionTasksList');
                Array.from(tasksList.children).forEach((item, index) => {
                    const orderDiv = item.querySelector('.mission-task-order');
                    if (orderDiv) orderDiv.textContent = index + 1;
                });
            },

            saveMission() {
                const title = document.getElementById('missionTitle').value.trim();
                const description = document.getElementById('missionDescription').value.trim();
                const deadline = document.getElementById('missionDeadline').value;
                
                if (!title || !deadline) {
                    alert('タイトルと期日は必須です');
                    return;
                }

                const tasksList = document.getElementById('missionTasksList');
                const tasks = [];
                Array.from(tasksList.children).forEach((item, index) => {
                    const titleInput = item.querySelector('input[type="text"]');
                    const descTextarea = item.querySelector('textarea');
                    const taskTitle = titleInput?.value.trim();
                    
                    if (taskTitle) {
                        tasks.push({
                            id: Date.now().toString() + '_' + index,
                            title: taskTitle,
                            description: descTextarea?.value.trim() || '',
                            order: index + 1,
                            completed: false
                        });
                    }
                });

                if (this.currentMission) {
                    // 編集
                    this.currentMission.title = title;
                    this.currentMission.description = description;
                    this.currentMission.deadline = deadline;
                    this.currentMission.tasks = tasks;
                } else {
                    // 新規作成
                    const mission = {
                        id: Date.now().toString(),
                        title: title,
                        description: description,
                        deadline: deadline,
                        tasks: tasks,
                        timestamp: Date.now()
                    };
                    this.missions.push(mission);
                }

                this.saveLocalData();
                this.newMission();
                this.renderMissions();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            viewMission(mission) {
                this.currentMission = mission;
                document.getElementById('missionViewerHeader').textContent = mission.title;
                document.getElementById('missionViewDescription').textContent = mission.description || '(説明なし)';
                document.getElementById('missionViewDeadline').textContent = `Deadline: ${mission.deadline}`;
                
                const completedCount = mission.tasks.filter(t => t.completed).length;
                document.getElementById('missionProgress').textContent = `${completedCount}/${mission.tasks.length}`;
                
                const tasksList = document.getElementById('missionViewTasksList');
                tasksList.innerHTML = '';
                
                mission.tasks.forEach(task => {
                    const div = document.createElement('div');
                    div.className = 'mission-task-item' + (task.completed ? ' completed' : '');
                    
                    const order = document.createElement('div');
                    order.className = 'mission-task-order';
                    order.textContent = task.order;
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'task-checkbox' + (task.completed ? ' checked' : '');
                    checkbox.style.marginLeft = '10px';
                    checkbox.onclick = () => {
                        task.completed = !task.completed;
                        this.saveLocalData();
                        this.viewMission(mission);
                        this.renderMissions();
                        if (this.githubToken && this.gistId) {
                            this.syncData();
                        }
                    };
                    
                    const content = document.createElement('div');
                    content.className = 'mission-task-content';
                    content.style.flex = '1';
                    
                    const title = document.createElement('div');
                    title.className = 'mission-task-title';
                    title.textContent = task.title;
                    title.style.textDecoration = task.completed ? 'line-through' : 'none';
                    
                    content.appendChild(title);
                    
                    if (task.description) {
                        const desc = document.createElement('div');
                        desc.className = 'mission-task-desc';
                        desc.textContent = task.description;
                        content.appendChild(desc);
                    }
                    
                    div.appendChild(order);
                    div.appendChild(checkbox);
                    div.appendChild(content);
                    tasksList.appendChild(div);
                });
                
                document.getElementById('missionEditor').style.display = 'none';
                document.getElementById('missionViewer').style.display = 'flex';
                this.renderMissions();
            },

            editMissionFromViewer() {
                if (!this.currentMission) return;
                
                document.getElementById('missionTitle').value = this.currentMission.title;
                document.getElementById('missionDescription').value = this.currentMission.description || '';
                document.getElementById('missionDeadline').value = this.currentMission.deadline;
                document.getElementById('missionEditorHeader').textContent = 'EDIT MISSION';
                document.getElementById('btnDeleteMission').style.display = 'block';
                
                const tasksList = document.getElementById('missionTasksList');
                tasksList.innerHTML = '';
                
                this.currentMission.tasks.forEach((task, index) => {
                    const div = document.createElement('div');
                    div.className = 'mission-task-item';
                    div.style.display = 'block';
                    div.style.padding = '15px';
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div class="mission-task-order">${task.order}</div>
                            <button class="mission-task-remove" onclick="this.parentElement.parentElement.remove(); app.reorderMissionTasks();">REMOVE</button>
                        </div>
                        <input type="text" class="task-input" value="${task.title}" placeholder="Task title..." style="margin-bottom: 8px; width: 100%;" />
                        <textarea class="editor-textarea" placeholder="Description (optional)..." style="height: 80px; font-size: 13px; padding: 10px; width: 100%; resize: vertical;">${task.description || ''}</textarea>
                    `;
                    tasksList.appendChild(div);
                });
                
                document.getElementById('missionEditor').style.display = 'flex';
                document.getElementById('missionViewer').style.display = 'none';
            },

            closeMissionViewer() {
                this.newMission();
            },

            deleteMission() {
                if (!this.currentMission) return;
                if (!confirm('このミッションを削除しますか？')) return;

                this.missions = this.missions.filter(m => m.id !== this.currentMission.id);
                this.saveLocalData();
                this.newMission();
                this.renderMissions();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            deleteTask() {
                if (!this.currentTask) return;
                if (!confirm('このタスクを削除しますか？')) return;

                this.tasks = this.tasks.filter(t => t.id !== this.currentTask.id);
                this.saveLocalData();
                this.newTask();
                this.renderTasks();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            // ========== Budget Management ==========

            renderTransactions() {
                if (this.budgetView === 'list') {
                    this.renderTransactionsList();
                } else {
                    this.renderSummary();
                }
            },

            renderTransactionsList() {
                const list = document.getElementById('transactionsList');
                list.style.display = 'block';
                document.getElementById('summaryView').style.display = 'none';
                list.innerHTML = '';
                
                this.transactions.forEach(transaction => {
                    const div = document.createElement('div');
                    div.className = 'entry-item' + (this.currentTransaction === transaction ? ' selected' : '');
                    div.onclick = () => this.editTransaction(transaction);
                    
                    const typeColor = transaction.type === 'income' ? '#22c55e' : '#dc2626';
                    const sign = transaction.type === 'income' ? '+' : '-';
                    
                    div.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                            <div style="font-size: 11px;">${transaction.date}</div>
                            <div style="font-size: 14px; font-weight: bold; color: ${typeColor};">${sign}¥${transaction.amount.toLocaleString()}</div>
                        </div>
                        <div style="font-size: 12px; margin-bottom: 3px;">${transaction.category}</div>
                        <div style="font-size: 10px; color: #16a34a;">${transaction.memo || '(メモなし)'}</div>
                    `;
                    list.appendChild(div);
                });

                document.getElementById('transactionCount').textContent = this.transactions.length;
            },

            renderSummary() {
                const list = document.getElementById('transactionsList');
                const summary = document.getElementById('summaryView');
                list.style.display = 'none';
                summary.style.display = 'block';
                
                // 月別でグループ化
                const monthlyData = {};
                this.transactions.forEach(t => {
                    const month = t.date.substring(0, 7); // YYYY-MM
                    if (!monthlyData[month]) {
                        monthlyData[month] = { income: 0, expense: 0, categories: {} };
                    }
                    
                    if (t.type === 'income') {
                        monthlyData[month].income += t.amount;
                    } else {
                        monthlyData[month].expense += t.amount;
                        if (!monthlyData[month].categories[t.category]) {
                            monthlyData[month].categories[t.category] = 0;
                        }
                        monthlyData[month].categories[t.category] += t.amount;
                    }
                });
                
                // 残高計算
                let balance = 0;
                this.transactions.forEach(t => {
                    balance += t.type === 'income' ? t.amount : -t.amount;
                });
                
                summary.innerHTML = `
                    <div style="border: 2px solid #22c55e; padding: 15px; margin-bottom: 15px; background: rgba(34, 197, 94, 0.1);">
                        <div style="font-size: 12px; margin-bottom: 5px;">CURRENT BALANCE:</div>
                        <div style="font-size: 24px; font-weight: bold; color: ${balance >= 0 ? '#22c55e' : '#dc2626'};">¥${balance.toLocaleString()}</div>
                    </div>
                `;
                
                // 月別サマリー
                const months = Object.keys(monthlyData).sort().reverse();
                months.forEach(month => {
                    const data = monthlyData[month];
                    const net = data.income - data.expense;
                    
                    let categoryHtml = '';
                    Object.entries(data.categories).sort((a, b) => b[1] - a[1]).forEach(([cat, amount]) => {
                        categoryHtml += `
                            <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px;">
                                <span>${cat}</span>
                                <span>¥${amount.toLocaleString()}</span>
                            </div>
                        `;
                    });
                    
                    summary.innerHTML += `
                        <div style="border: 1px solid #166534; padding: 12px; margin-bottom: 10px;">
                            <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #16a34a;">${month}</div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #22c55e;">Income:</span>
                                <span style="color: #22c55e;">¥${data.income.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="color: #dc2626;">Expense:</span>
                                <span style="color: #dc2626;">¥${data.expense.toLocaleString()}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #16a34a;">
                                <span style="font-weight: bold;">Net:</span>
                                <span style="font-weight: bold; color: ${net >= 0 ? '#22c55e' : '#dc2626'};">¥${net.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 11px; color: #16a34a; margin-bottom: 5px;">Category Breakdown:</div>
                            ${categoryHtml}
                        </div>
                    `;
                });
                
                document.getElementById('transactionCount').textContent = this.transactions.length;
            },

            setBudgetView(view) {
                this.budgetView = view;
                
                // ボタンのアクティブ状態を更新
                document.querySelectorAll('#budgetContent .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
                
                this.renderTransactions();
            },

            setTransactionType(type) {
                this.transactionType = type;
                
                document.getElementById('typeIncome').classList.remove('active');
                document.getElementById('typeExpense').classList.remove('active');
                
                if (type === 'income') {
                    document.getElementById('typeIncome').classList.add('active');
                } else {
                    document.getElementById('typeExpense').classList.add('active');
                }
            },

            newTransaction() {
                this.currentTransaction = null;
                this.transactionType = 'expense';
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('transactionCategory').value = '食費';
                document.getElementById('transactionAmount').value = '';
                document.getElementById('transactionMemo').value = '';
                document.getElementById('budgetEditorHeader').textContent = 'NEW TRANSACTION';
                document.getElementById('btnDeleteTransaction').style.display = 'none';
                
                document.getElementById('typeIncome').classList.remove('active');
                document.getElementById('typeExpense').classList.add('active');
                
                this.renderTransactions();
            },

            saveTransaction() {
                const date = document.getElementById('transactionDate').value;
                const category = document.getElementById('transactionCategory').value;
                const amount = parseFloat(document.getElementById('transactionAmount').value);
                const memo = document.getElementById('transactionMemo').value.trim();
                
                if (!date || !amount || amount <= 0) {
                    alert('日付と金額は必須です');
                    return;
                }

                if (this.currentTransaction) {
                    // 編集
                    this.currentTransaction.type = this.transactionType;
                    this.currentTransaction.date = date;
                    this.currentTransaction.category = category;
                    this.currentTransaction.amount = amount;
                    this.currentTransaction.memo = memo;
                } else {
                    // 新規作成
                    const transaction = {
                        id: Date.now().toString(),
                        type: this.transactionType,
                        date: date,
                        category: category,
                        amount: amount,
                        memo: memo,
                        timestamp: Date.now()
                    };
                    this.transactions.push(transaction);
                }

                this.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                this.saveLocalData();
                this.newTransaction();
                this.renderTransactions();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            editTransaction(transaction) {
                this.currentTransaction = transaction;
                this.transactionType = transaction.type;
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionCategory').value = transaction.category;
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionMemo').value = transaction.memo || '';
                document.getElementById('budgetEditorHeader').textContent = 'EDIT TRANSACTION';
                document.getElementById('btnDeleteTransaction').style.display = 'block';
                
                document.getElementById('typeIncome').classList.remove('active');
                document.getElementById('typeExpense').classList.remove('active');
                
                if (transaction.type === 'income') {
                    document.getElementById('typeIncome').classList.add('active');
                } else {
                    document.getElementById('typeExpense').classList.add('active');
                }
                
                this.renderTransactions();
            },

            deleteTransaction() {
                if (!this.currentTransaction) return;
                if (!confirm('この取引を削除しますか？')) return;

                this.transactions = this.transactions.filter(t => t.id !== this.currentTransaction.id);
                this.saveLocalData();
                this.newTransaction();
                this.renderTransactions();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            deleteEntry() {
                if (!this.currentEntry) return;
                if (!confirm('このエントリーを削除しますか？')) return;

                this.entries = this.entries.filter(e => e.id !== this.currentEntry.id);
                this.saveLocalData();
                this.newEntry();
                this.render();

                // 自動同期
                if (this.githubToken && this.gistId) {
                    this.syncData();
                }
            },

            saveSettings() {
                const token = document.getElementById('githubToken').value.trim();
                const gistId = document.getElementById('gistId').value.trim();

                if (!token) {
                    alert('Personal Access Tokenを入力してください');
                    return;
                }

                this.githubToken = token;
                this.gistId = gistId;

                localStorage.setItem('githubToken', token);
                if (gistId) {
                    localStorage.setItem('gistId', gistId);
                }

                document.getElementById('settingsModal').classList.remove('active');
                this.syncData();
            },

            async syncData() {
                if (!this.githubToken) {
                    document.getElementById('settingsModal').classList.add('active');
                    return;
                }

                const btnSync = document.getElementById('btnSync');
                const originalText = btnSync.textContent;
                btnSync.textContent = 'SYNCING...';
                btnSync.disabled = true;

                try {
                    if (this.gistId) {
                        // 既存のGistから読み込み
                        await this.pullFromGist();
                    }
                    
                    // Gistにプッシュ
                    await this.pushToGist();
                    
                    btnSync.textContent = 'SYNCED!';
                    setTimeout(() => {
                        btnSync.textContent = originalText;
                        btnSync.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('Sync error:', error);
                    alert('同期エラー: ' + error.message);
                    btnSync.textContent = 'ERROR';
                    setTimeout(() => {
                        btnSync.textContent = originalText;
                        btnSync.disabled = false;
                    }, 2000);
                }
            },

            async pullFromGist() {
                const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
                    headers: {
                        'Authorization': `token ${this.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) throw new Error('Gistの読み込みに失敗しました');

                const gist = await response.json();
                
                // ジャーナルエントリーの同期
                const journalContent = gist.files['journal.json']?.content;
                if (journalContent) {
                    const remoteEntries = JSON.parse(journalContent);
                    const mergedEntries = [...this.entries];
                    remoteEntries.forEach(remote => {
                        if (!mergedEntries.find(local => local.id === remote.id)) {
                            mergedEntries.push(remote);
                        }
                    });
                    this.entries = mergedEntries.sort((a, b) => b.timestamp - a.timestamp);
                }

                // タスクの同期
                const tasksContent = gist.files['tasks.json']?.content;
                if (tasksContent) {
                    const remoteTasks = JSON.parse(tasksContent);
                    const mergedTasks = [...this.tasks];
                    remoteTasks.forEach(remote => {
                        const local = mergedTasks.find(l => l.id === remote.id);
                        if (!local) {
                            mergedTasks.push(remote);
                        } else {
                            if (remote.timestamp > local.timestamp) {
                                Object.assign(local, remote);
                            }
                        }
                    });
                    this.tasks = mergedTasks.sort((a, b) => a.completed - b.completed || b.timestamp - a.timestamp);
                }

                // ミッションの同期
                const missionsContent = gist.files['missions.json']?.content;
                if (missionsContent) {
                    const remoteMissions = JSON.parse(missionsContent);
                    const mergedMissions = [...this.missions];
                    remoteMissions.forEach(remote => {
                        const local = mergedMissions.find(l => l.id === remote.id);
                        if (!local) {
                            mergedMissions.push(remote);
                        } else {
                            if (remote.timestamp > local.timestamp) {
                                Object.assign(local, remote);
                            }
                        }
                    });
                    this.missions = mergedMissions.sort((a, b) => b.timestamp - a.timestamp);
                }

                // 家計簿の同期
                const transactionsContent = gist.files['transactions.json']?.content;
                if (transactionsContent) {
                    const remoteTransactions = JSON.parse(transactionsContent);
                    const mergedTransactions = [...this.transactions];
                    remoteTransactions.forEach(remote => {
                        const local = mergedTransactions.find(l => l.id === remote.id);
                        if (!local) {
                            mergedTransactions.push(remote);
                        } else {
                            if (remote.timestamp > local.timestamp) {
                                Object.assign(local, remote);
                            }
                        }
                    });
                    this.transactions = mergedTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                }

                this.saveLocalData();
                this.render();
            },

            async pushToGist() {
                const data = {
                    description: 'PIP-BOY Journal, Tasks, Missions & Budget Data',
                    public: false,
                    files: {
                        'journal.json': {
                            content: JSON.stringify(this.entries, null, 2)
                        },
                        'tasks.json': {
                            content: JSON.stringify(this.tasks, null, 2)
                        },
                        'missions.json': {
                            content: JSON.stringify(this.missions, null, 2)
                        },
                        'transactions.json': {
                            content: JSON.stringify(this.transactions, null, 2)
                        }
                    }
                };

                const url = this.gistId 
                    ? `https://api.github.com/gists/${this.gistId}`
                    : 'https://api.github.com/gists';

                const method = this.gistId ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `token ${this.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Gistへの保存に失敗しました');

                const gist = await response.json();
                
                if (!this.gistId) {
                    this.gistId = gist.id;
                    localStorage.setItem('gistId', gist.id);
                }
            }
        };

        // 初期化
        window.addEventListener('DOMContentLoaded', () => app.init());

        // 設定モーダルを開くショートカット（Ctrl+K）
        window.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                document.getElementById('settingsModal').classList.add('active');
            }
        });
    </script>
</body>
</html>
